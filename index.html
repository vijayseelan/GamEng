<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GamEng!</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General Styles */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

:root {
    --bg-color: linear-gradient(135deg, #FFA500, #FFFFFF, #4169E1);
    --text-color: #1a202c;
    --card-bg: rgba(255, 255, 255, 0.8);
    --card-text: #1a202c;
    --sidebar-bg: #4169E1;
    --sidebar-text: #FFFFFF;
    --primary-color: #4169E1;
    --secondary-color: #FFA500;
    --accent-color: #FF6347;
}

body {
    font-family: 'Poppins', sans-serif;
    background: var(--bg-color);
    color: var(--text-color);
    min-height: 100vh;
}

/* Neumorphic Styles */
.neumorphic {
    background: var(--card-bg);
    border-radius: 15px;
    box-shadow: 8px 8px 15px rgba(0, 0, 0, 0.1), -8px -8px 15px rgba(255, 255, 255, 0.5);
    transition: all 0.3s ease;
}

.neumorphic:hover {
    transform: translateY(-5px);
    box-shadow: 12px 12px 20px rgba(0, 0, 0, 0.15), -12px -12px 20px rgba(255, 255, 255, 0.6);
}

.neumorphic-inset {
    background: var(--card-bg);
    box-shadow: inset 5px 5px 10px rgba(0, 0, 0, 0.1), inset -5px -5px 10px rgba(255, 255, 255, 0.5);
    border-radius: 10px;
    border: none;
    outline: none;
    transition: all 0.3s ease;
}

.neumorphic-inset:focus {
    box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.1), inset -3px -3px 6px rgba(255, 255, 255, 0.5);
}

/* Bubbly Button */
.neumorphic-button, button {
    background: var(--primary-color);
    color: white !important;
    border: none;
    border-radius: 10px;
    padding: 12px 20px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
}

.neumorphic-button:hover, button:hover {
        background: var(--secondary-color);
        color: var(--text-color) !important;
        transform: translateY(-3px);
        box-shadow: 6px 6px 12px rgba(0, 0, 0, 0.15);
    }

    .neumorphic-button *, button * {
        color: white !important;
    }

    .badge-buttons button {
        background: var(--secondary-color);
        color: var(--text-color) !important;
    }

    .badge-buttons button:hover {
        background: var(--accent-color);
        color: white !important;
    }

    #sidebar ul li a {
        color: white !important;
    }

    #sidebar ul li a:hover, #sidebar ul li a.active {
        color: var(--text-color) !important;
    }

    .text-indigo-600 {
        color: var(--primary-color);
    }

    .neumorphic-button.text-indigo-600,
    button.text-indigo-600,
    .neumorphic-button .text-indigo-600,
    button .text-indigo-600 {
        color: white !important;
    }

    button[onclick="logout()"] {
        color: white !important;
    }

    button[onclick="logout()"]:hover {
        color: var(--text-color) !important;
    }

    /* Progress Bar */
    .progress-bar {
        background: var(--card-bg);
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        height: 20px;
        margin: 10px 0;
    }

    .progress {
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        box-shadow: 0 0 10px var(--primary-color);
        border-radius: 10px;
        transition: width 0.5s ease-in-out;
        height: 100%;
    }

    /* Sidebar */
    #sidebar {
    background: linear-gradient(to bottom, #4338ca, #3730a3);
    color: white;
    min-height: 100vh;
    width: 250px;
    padding: 1rem;
    transition: all 0.3s ease;
    font-family: 'Arial', sans-serif;
}

#sidebar h2 {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 2rem;
    text-align: center;
    color: #f3f4f6;
    text-transform: uppercase;
    letter-spacing: 2px;
}

#sidebar ul {
    list-style-type: none;
    padding: 0;
}

#sidebar li {
    margin-bottom: 0.5rem;
}

#sidebar a {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    color: #e0e7ff;
    text-decoration: none;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
    font-size: 0.9rem;
}

#sidebar a:hover {
    background-color: rgba(255, 255, 255, 0.1);
    transform: translateX(5px);
}

#sidebar .mode-title {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: #a5b4fc;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    padding-left: 1rem;
    font-weight: bold;
    letter-spacing: 1px;
}

#sidebar svg {
    width: 1.5rem;
    height: 1.5rem;
    margin-right: 0.75rem;
}

#logout-button {
    width: 100%;
    padding: 0.75rem;
    background-color: #ef4444;
    color: white;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
    margin-top: 2rem;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
}

#logout-button:hover {
    background-color: #dc2626;
}

/* Add a subtle animation for the sidebar */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

#sidebar {
    animation: fadeIn 0.5s ease-in-out;
}

    /* Main Content */
    #main-content {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 20px;
        margin: 20px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

    /* Auth Container Styles */
    #auth-container {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
    }

    #auth-container .neumorphic {
        background: var(--card-bg);
        border-radius: 20px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    #app-name {
        color: var(--primary-color);
        font-size: 3rem;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
        animation: float 3s ease-in-out infinite;
    }

    #auth-title {
        color: var(--secondary-color);
        font-size: 1.8rem;
        margin-bottom: 2rem;
    }

    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }

    /* Input fields in auth container */
    #auth-container input {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 10px;
        border: 2px solid var(--primary-color);
        background: var(--card-bg);
        color: var(--text-color);
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
    }

    #auth-container input:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 10px rgba(65, 105, 225, 0.3);
    }

    /* Buttons in auth container */
    #auth-container button {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        border-radius: 10px;
        background: var(--primary-color);
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    #auth-container button:hover {
        background: var(--secondary-color);
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    /* Links in auth container */
    #auth-container a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    #auth-container a:hover {
        color: var(--secondary-color);
        text-decoration: underline;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 10px;
    }

    ::-webkit-scrollbar-track {
        background: var(--card-bg);
        border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--secondary-color);
    }

    #register-gamification-mode {
        background-color: var(--card-bg);
        color: var(--text-color);
        border: 2px solid var(--primary-color);
        border-radius: 10px;
        padding: 10px;
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
        display: block !important;
    }

    #register-gamification-mode.hidden {
        display: none !important;
    }

    #register-gamification-mode:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 10px rgba(65, 105, 225, 0.3);
    }

    #register-gamification-mode option {
        background-color: var(--card-bg);
        color: var(--text-color);
    }

    /* Additional styles for specific elements */
    #app-title {
        color: var(--sidebar-text);
        font-size: 28px;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .badge-buttons button {
        font-size: 14px;
        padding: 8px 16px;
        margin: 5px;
        background: var(--secondary-color);
        color: var(--text-color);
    }

    .badge-buttons button:hover {
        background: var(--accent-color);
        color: var(--sidebar-text);
        transform: rotate(5deg) scale(1.1);
    }
    .badge-button {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        border-radius: 1rem;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .badge-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }

    .badge-button .emoji {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .badge-button .badge-name {
        font-size: 0.8rem;
        font-weight: bold;
        text-align: center;
    }

    #avatar {
        border: 4px solid var(--sidebar-text);
        border-radius: 50%;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    #avatar:hover {
        transform: scale(1.1) rotate(5deg);
    }

    .message-container {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .message-container:hover {
        transform: translateY(-5px);
        box-shadow: 8px 8px 20px rgba(0, 0, 0, 0.15);
    }

    #lessons-list .neumorphic, #lessons-management-list .neumorphic {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    #lessons-list img, #lessons-management-list img {
        border-radius: 10px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }

    #lessons-list img:hover, #lessons-management-list img:hover {
        transform: scale(1.05);
    }

    /* Form inputs */
    input[type="text"], input[type="email"], input[type="password"], select, textarea {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 10px;
        border: 2px solid var(--primary-color);
        background: var(--card-bg);
        color: var(--text-color);
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
    }

    input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, select:focus, textarea:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 10px rgba(255, 165, 0, 0.3);
    }

    /* Lesson card styles */
    .lesson-card {
        background: var(--card-bg);
        border-radius: 15px;
        transition: all 0.3s ease;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .lesson-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .lesson-card-header {
        padding: 1.5rem;
        cursor: pointer;
        font-weight: 600;
        color: var(--primary-color);
    }

    .lesson-card-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }

    .lesson-card-content.expanded {
        max-height: 1000px;
        transition: max-height 0.5s ease-in;
    }

    .lesson-card-body {
        padding: 0 1.5rem 1.5rem;
    }

    .lesson-card-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
        transition: all 0.3s ease;
    }

    .lesson-card-image:hover {
        transform: scale(1.05);
    }

    /* Animations */
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }

    .float-animation {
        animation: float 3s ease-in-out infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .pulse-animation {
        animation: pulse 2s ease-in-out infinite;
    }

    /* Apply animations */
    .neumorphic {
        animation: float 3s ease-in-out infinite;
    }

    .neumorphic-button, button {
        animation: pulse 2s ease-in-out infinite;
    }

    /* Timer styles */
    #timer-display {
        font-size: 48px;
        font-weight: bold;
        color: var(--primary-color);
        text-align: center;
        margin: 20px 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Mood emoji styles */
    .mood-emoji {
        font-size: 24px;
        margin: 0 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .mood-emoji:hover, .mood-emoji.selected {
        transform: scale(1.2);
    }

    /* Post card styles */
    .post-card {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .post-card:hover {
        transform: translateY(-5px);
        box-shadow: 8px 8px 20px rgba(0, 0, 0, 0.15);
    }

    /* Leaderboard styles */
    #individual-leaderboard-list li, #team-leaderboard-list li {
        background: var(--primary-color);
        color: var(--sidebar-text);
        padding: 10px 15px;
        margin-bottom: 10px;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    #individual-leaderboard-list li:hover, #team-leaderboard-list li:hover {
        transform: scale(1.05);
        background: var(--secondary-color);
    }

    /* Theme selection styles */
    .theme-button {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .theme-button:hover {
        transform: scale(1.1);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        #sidebar {
            border-radius: 0 0 20px 20px;
        }

        .neumorphic, .neumorphic-button, button {
            font-size: 14px;
        }
    }

    /* Theme styles */
    .theme-default {
        --bg-color: linear-gradient(135deg, #FFA500, #FFFFFF, #4169E1);
        --text-color: #1a202c;
        --card-bg: rgba(255, 255, 255, 0.8);
        --card-text: #1a202c;
        --sidebar-bg: #4169E1;
        --sidebar-text: #FFFFFF;
    }

   
/* Dark Theme */
.theme-dark {
    background: linear-gradient(135deg, #121212, #1E1E1E, #2C2C2C);
    color: #E0E0E0;
}
.theme-dark #sidebar { 
    background-color: rgba(18, 18, 18, 0.9); 
}
.theme-dark .neumorphic-button { 
    background-color: #3A3A3A; 
    color: #E0E0E0; 
    box-shadow: 3px 3px 6px #0a0a0a, -3px -3px 6px #3e3e3e;
}
.theme-dark .neumorphic-button:hover {
    box-shadow: inset 3px 3px 6px #0a0a0a, inset -3px -3px 6px #3e3e3e;
}
.theme-dark #main-content {
    background-color: rgba(30, 30, 30, 0.8);
}

/* Light Theme */
.theme-light {
    background: linear-gradient(135deg, #F5F5F5, #E0E0E0, #FAFAFA);
    color: #333333;
}
.theme-light #sidebar { 
    background-color: rgba(224, 224, 224, 0.9); 
    color: #333333;
}
.theme-light .neumorphic-button { 
    background-color: #E0E0E0; 
    color: #333333; 
    box-shadow: 3px 3px 6px #bebebe, -3px -3px 6px #ffffff;
}
.theme-light .neumorphic-button:hover {
    box-shadow: inset 3px 3px 6px #bebebe, inset -3px -3px 6px #ffffff;
}
.theme-light #main-content {
    background-color: rgba(250, 250, 250, 0.8);
}

/* Nature Theme */
.theme-nature {
    background: linear-gradient(135deg, #4CAF50, #8BC34A, #CDDC39);
    color: #1B5E20;
}
.theme-nature #sidebar { 
    background-color: rgba(76, 175, 80, 0.9); 
    color: #FFFFFF;
}
.theme-nature .neumorphic-button { 
    background-color: #66BB6A; 
    color: #FFFFFF; 
    box-shadow: 3px 3px 6px #3e8e41, -3px -3px 6px #8ed082;
}
.theme-nature .neumorphic-button:hover {
    box-shadow: inset 3px 3px 6px #3e8e41, inset -3px -3px 6px #8ed082;
}
.theme-nature #main-content {
    background-color: rgba(255, 255, 255, 0.8);
    color: #1B5E20;
}
    /* Ocean Breeze */
.theme-ocean-breeze {
    background: linear-gradient(135deg, #48CAE4, #0096C7, #023E8A);
    color: #E0F2FE;
}
.theme-ocean-breeze #sidebar { background-color: rgba(2, 62, 138, 0.9); }
.theme-ocean-breeze .neumorphic-button { background-color: #0077B6; color: white; }

/* Sunset Glow */
.theme-sunset-glow {
    background: linear-gradient(135deg, #FF9E00, #FF4E50, #F9C80E);
    color: #4A0E0E;
}
.theme-sunset-glow #sidebar { background-color: rgba(249, 200, 14, 0.9); color: #4A0E0E; }
.theme-sunset-glow .neumorphic-button { background-color: #FF4E50; color: white; }

/* Forest Mist */
.theme-forest-mist {
    background: linear-gradient(135deg, #2D6A4F, #40916C, #95D5B2);
    color: #081C15;
}
.theme-forest-mist #sidebar { background-color: rgba(45, 106, 79, 0.9); color: #D8F3DC; }
.theme-forest-mist .neumorphic-button { background-color: #1B4332; color: white; }

/* Cosmic Purple */
.theme-cosmic-purple {
    background: linear-gradient(135deg, #7B2CBF, #9D4EDD, #C77DFF);
    color: #FFEBFF;
}
.theme-cosmic-purple #sidebar { background-color: rgba(123, 44, 191, 0.9); }
.theme-cosmic-purple .neumorphic-button { background-color: #5A189A; color: white; }

/* Citrus Burst */
.theme-citrus-burst {
    background: linear-gradient(135deg, #FF9F1C, #FFBF69, #CBF3F0);
    color: #2EC4B6;
}
.theme-citrus-burst #sidebar { background-color: rgba(255, 159, 28, 0.9); color: #FFFFFF; }
.theme-citrus-burst .neumorphic-button { background-color: #2EC4B6; color: white; }

/* Midnight Sky */
.theme-midnight-sky {
    background: linear-gradient(135deg, #0B090A, #161A1D, #660708);
    color: #F5F3F4;
}
.theme-midnight-sky #sidebar { background-color: rgba(22, 26, 29, 0.9); }
.theme-midnight-sky .neumorphic-button { background-color: #660708; color: white; }

/* Cherry Blossom */
.theme-cherry-blossom {
    background: linear-gradient(135deg, #FFB3BA, #FFDFBA, #FFFFBA);
    color: #594A4E;
}
.theme-cherry-blossom #sidebar { background-color: rgba(255, 179, 186, 0.9); color: #594A4E; }
.theme-cherry-blossom .neumorphic-button { background-color: #FF85A1; color: white; }

/* Northern Lights */
.theme-northern-lights {
    background: linear-gradient(135deg, #01497C, #2C7DA0, #89C2D9);
    color: #CAF0F8;
}
.theme-northern-lights #sidebar { background-color: rgba(1, 73, 124, 0.9); }
.theme-northern-lights .neumorphic-button { background-color: #2C7DA0; color: white; }

    /* Pomodoro Timer styles */
    #timer-display {
        font-size: 3rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 1rem;
        color: var(--text-color);
    }

    .pomodoro-type.active {
        background-color: var(--text-color);
        color: var(--bg-color);
    }

    input[type="number"] {
        width: 100%;
        padding: 0.5rem;
        border-radius: 0.25rem;
        border: 1px solid var(--text-color);
        background-color: var(--bg-color);
        color: var(--text-color);
    }

    input[type="number"]:focus {
        outline: none;
        border-color: var(--text-color);
        box-shadow: 0 0 0 2px rgba(var(--text-color-rgb), 0.2);
    }

    /* Ripple effect for buttons */
    .ripple {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.7);
        transform: scale(0);
        animation: ripple 0.6s linear;
        pointer-events: none;
    }

    @keyframes ripple {
        to {
            transform: scale(4);
            opacity: 0;
        }
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(65, 105, 225, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(65, 105, 225, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(65, 105, 225, 0);
        }
    }

    .post-card {
        animation: pulse 2s infinite;
    }

    /* Avatar customization styles */
    #avatar-preview {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        margin: 0 auto;
        display: block;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }

    /* Microblog styles */
    #post-content {
        resize: vertical;
        min-height: 100px;
    }

    .mood-emoji {
        font-size: 24px;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .mood-emoji:hover {
        transform: scale(1.2);
    }

    /* Team management styles */
    #teams-list > div {
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 8px;
        background-color: var(--card-bg);
    }

    #teams-list h4 {
        margin-bottom: 0.5rem;
        font-weight: bold;
    }

    /* Lesson modal styles */
    #lesson-modal {
        z-index: 1000;
    }

    #lesson-modal > div {
        max-height: 90vh;
        overflow-y: auto;
    }

    /* Quill editor styles */
    .ql-editor {
        min-height: 200px;
        background-color: var(--card-bg);
        color: var(--text-color);
    }

    /* Responsive design adjustments */
    @media (max-width: 640px) {
        .grid-cols-2 {
            grid-template-columns: 1fr;
        }

        .grid-cols-3 {
            grid-template-columns: 1fr;
        }

        #sidebar {
            width: 100%;
            border-radius: 0;
        }

        #main-content {
            margin: 0;
            border-radius: 0;
        }
    }


.like-btn, .dislike-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2em;
    }
    .like-btn:hover, .dislike-btn:hover {
        opacity: 0.7;
    }

    #user-info {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
}

#user-info p {
    margin: 0 0 10px 0;
    font-size: 0.9rem;
    color: #e0e7ff;
}

#user-info p:last-child {
    margin-bottom: 0;
}

#user-info strong {
    color: #a5b4fc;
    font-weight: 600;
    margin-right: 5px;
}

#user-name, #user-role, #gamification-text {
    color: #ffffff;
    font-weight: 500;
}

#user-name {
    font-size: 1.1rem;
    margin-bottom: 5px;
    display: block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

#user-role, #gamification-text {
    display: inline-block;
    background: rgba(165, 180, 252, 0.2);
    padding: 3px 8px;
    border-radius: 15px;
    font-size: 0.7rem;
    margin-top: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}
#app-title {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
    padding: 10px;
    background: linear-gradient(45deg, #4338ca, #3730a3);
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

#app-title h1 {
    font-size: 2rem;
    font-weight: 800;
    color: #ffffff;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    margin: 0;
    letter-spacing: 1px;
}

.app-icon {
    width: 30px;
    height: 30px;
    margin-right: 10px;
    color: #ffffff;
}

/* Add a subtle animation */
@keyframes pulse {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.01);
    }
    100% {
        transform: scale(1);
    }
}

#app-title {
    animation: pulse 2s infinite;
}

#sidebar-toggle {
    display: none; /* Hidden by default on larger screens */
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 1000;
    background-color: #4338ca;
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    cursor: pointer;
    transition: background-color 0.3s;
}

#sidebar-toggle:hover {
    background-color: #3730a3;
}

@media (max-width: 768px) {
    #sidebar-toggle {
        display: block; /* Show on smaller screens */
    }

    #sidebar {
        position: fixed;
        left: -250px; /* Hide sidebar off-screen */
        transition: left 0.3s ease;
    }

    #sidebar.active {
        left: 0; /* Show sidebar when active */
    }

    #main-content {
        margin-left: 0;
    }
}
.resource-item {
    position: relative;
    overflow: hidden;
}

.resource-item:hover::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.1);
    pointer-events: none;
}

.fixed {
    transition: opacity 0.3s ease;
}

.fixed:not(.opacity-0) {
    opacity: 1;
}

.fixed.opacity-0 {
    opacity: 0;
    pointer-events: none;
}

    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="auth-container" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50">
        <div class="neumorphic p-8 w-full max-w-md">
            <h1 id="app-name" class="text-4xl font-bold mb-6 text-center text-primary-color">GamEng!</h1>
            <h2 id="auth-title" class="text-2xl font-bold mb-6 text-center text-indigo-600">Login</h2>
            
            <div id="login-container">
                <input type="email" id="login-email" placeholder="Email" required class="neumorphic-inset w-full p-3 mb-4" />
                <input type="password" id="login-password" placeholder="Password" required class="neumorphic-inset w-full p-3 mb-4" />
                <button id="login-button" onclick="login()" class="neumorphic-button w-full py-3 px-4 text-indigo-600 font-semibold mb-4">Login</button>
                <p class="text-center text-gray-600">Don't have an account? <a href="#" onclick="showRegisterForm()" class="text-indigo-600 font-semibold">Register</a></p>
                <p class="text-center text-gray-600"><a href="#" onclick="showForgotPasswordForm()" class="text-indigo-600 font-semibold">Forgot Password?</a></p>
            </div>
    
            <div id="register-container" class="hidden">
                <input type="text" id="register-name" placeholder="Full Name" class="neumorphic-inset w-full p-3 mb-4">
                <input type="email" id="register-email" placeholder="Email" class="neumorphic-inset w-full p-3 mb-4">
                <input type="password" id="register-password" placeholder="Password" class="neumorphic-inset w-full p-3 mb-4">
                <input type="text" id="register-school-code" placeholder="School Code" class="neumorphic-inset w-full p-3 mb-4">
                <select id="register-role" class="neumorphic-inset w-full p-3 mb-4" onchange="toggleGamificationMode()">
                    <option value="">Select Role</option>
                    <option value="student">Student</option>
                    <option value="teacher">Teacher</option>
                </select>
                <select id="register-gamification-mode" class="neumorphic-inset w-full p-3 mb-4 hidden">
                    <option value="">Select Gamification Mode</option>
                    <option value="competence">Competence</option>
                    <option value="autonomy">Autonomy</option>
                    <option value="relatedness">Relatedness</option>
                </select>
                <button onclick="register()" class="neumorphic-button w-full py-3 px-4 text-white font-semibold mb-4">Register</button>
                <p class="text-center text-gray-600">Already have an account? <a href="#" onclick="showLoginForm()" class="text-indigo-600 font-semibold">Login</a></p>
            </div>
            <div id="forgot-password-container" class="hidden">
                <input type="email" id="reset-email" placeholder="Email" required class="neumorphic-inset w-full p-3 mb-4" />
                <button onclick="resetPassword()" class="neumorphic-button w-full py-3 px-4 text-indigo-600 font-semibold mb-4">Reset Password</button>
                <p class="text-center text-gray-600"><a href="#" onclick="showLoginForm()" class="text-indigo-600 font-semibold">Back to Login</a></p>
            </div>
        </div>
    </div>

<div class="flex h-screen">
    <div id="sidebar" class="neumorphic w-64 p-6 flex flex-col justify-between hidden">
        
        <div>
            <div id="app-title">
                <svg class="app-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 6h16M4 12h16m-7 6h7"/>
                    <path d="M12 3v18"/>
                </svg>
                <h1>GamEng!</h1>
            </div>
            <div id="user-info">
                <p><strong>Name:</strong> <span id="user-name"></span></p>
                <p><strong>Role:</strong> <span id="user-role"></span></p>
                <p><strong>Mode:</strong> <span id="gamification-text"></span></p>
            </div>
            <div id="sidebar-content" class="space-y-4"></div>
        </div>
        <button onclick="logout()" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold hover:text-indigo-700">Logout</button>
    </div>

    <button id="sidebar-toggle" aria-label="Toggle Sidebar">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
    </button>

    <div id="main-content" class="flex-1 p-8 overflow-y-auto hidden">
        <div id="lesson-content">
            <!-- Competence Mode -->
            <div id="competence-mode" class="hidden space-y-8">
                <h3 class="text-2xl font-semibold text-center text-indigo-600 mb-6">Competence Mode</h3>

                <!-- Individual Leaderboard -->
                <div id="individual-leaderboard" class="neumorphic p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-600">Individual Leaderboard</h3>
                    <ul id="individual-leaderboard-list" class="space-y-2"></ul>
                </div>

                <!-- Award Points and Badges to Students (Visible to Teachers Only) -->
                <div id="points-award" class="hidden space-y-6">
                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Award Points to Students</h3>
                        <select id="student-list" class="neumorphic-inset w-full p-2 mb-4"></select>
                        <div class="point-buttons grid grid-cols-2 gap-4">
                            <button onclick="adjustPoints(10)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+10xp</button>
                            <button onclick="adjustPoints(20)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+20xp</button>
                            <button onclick="adjustPoints(50)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+50xp</button>
                            <button onclick="adjustPoints(100)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+100xp</button>
                            <button onclick="adjustPoints(-10)" class="neumorphic-button py-2 px-4 text-red-600 font-semibold">-10xp</button>
                            <button onclick="adjustPoints(-20)" class="neumorphic-button py-2 px-4 text-red-600 font-semibold">-20xp</button>
                            <button onclick="adjustPoints(-50)" class="neumorphic-button py-2 px-4 text-red-600 font-semibold">-50xp</button>
                            <button onclick="adjustPoints(-100)" class="neumorphic-button py-2 px-4 text-red-600 font-semibold">-100xp</button>
                        </div>
                    </div>

                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Award Badges to Students</h3>
                        <div class="badge-buttons grid grid-cols-2 gap-4">
                            <button onclick="awardBadge('first to answer')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">First to Answer</button>
                            <button onclick="awardBadge('first to finish')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">First to Finish</button>
                            <button onclick="awardBadge('Hardworking')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Hardworking</button>
                            <button onclick="awardBadge('Team Player')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Team Player</button>
                            <button onclick="awardBadge('Creative Thinker')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Creative Thinker</button>
                            <button onclick="awardBadge('Problem Solver')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Problem Solver</button>
                            <button onclick="awardBadge('Critical Thinker')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Critical Thinker</button>
                            <button onclick="awardBadge('Persistent')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Persistent</button>
                            <button onclick="awardBadge('Quick Learner')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Quick Learner</button>
                            <button onclick="awardBadge('Leader')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Leader</button>
                        </div>
                    </div>
                </div>

                <!-- Student Progress Bar (Visible to Students Only) -->
                <div id="student-progress" class="hidden space-y-6">
                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Your Progress</h3>
                        <div class="mb-4">
                            <span id="current-level" class="text-indigo-600 font-semibold"></span>
                            <div class="progress-bar h-4 mt-2">
                                <div id="progress" class="progress h-full"></div>
                            </div>
                            <span id="next-level" class="text-indigo-600 font-semibold"></span>
                        </div>
                        <div class="badge-container">
                            <h4 class="text-lg font-semibold mb-2 text-indigo-600">Your Badges</h4>
                            <div id="earned-badges" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Autonomy Mode -->
            <div id="autonomy-mode" class="hidden space-y-8">
                <h3 class="text-2xl font-semibold text-center text-indigo-600 mb-6">Autonomy Mode</h3>
                <div id="avatar-customization" class="neumorphic p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-600">Customize Your Avatar</h3>
                    <img id="avatar-preview" src="https://avataaars.io/?avatarStyle=Circle" alt="Avatar" class="w-32 h-32 rounded-full mx-auto mb-4" />
                    <button onclick="randomizeAvatar()" class="neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold mb-4">Randomize Avatar</button>
                    <button onclick="saveAvatar()" class="neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold">Save Avatar</button>
                </div>
            </div>

            <div id="theme-selection" class="hidden space-y-6">
                <div class="neumorphic p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-600">Theme Selection</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    </div>
                </div>
            </div>
            
            <div id="pomodoro-timer" class="hidden space-y-6">
                <div class="neumorphic p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-600">Pomodoro Timer</h3>
                    <div id="timer-display" class="text-4xl font-bold text-center mb-4">25:00</div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <button id="start-timer" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">Start</button>
                        <button id="reset-timer" class="neumorphic-button py-2 px-4 text-red-600 font-semibold">Reset</button>
                    </div>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div>
                            <input type="number" id="pomodoro-time" class="neumorphic-inset w-full p-2 mb-2" value="25" min="1" max="60">
                            <button class="pomodoro-type neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold" data-type="pomodoro">Pomodoro</button>
                        </div>
                        <div>
                            <input type="number" id="short-break-time" class="neumorphic-inset w-full p-2 mb-2" value="5" min="1" max="30">
                            <button class="pomodoro-type neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold" data-type="shortBreak">Short Break</button>
                        </div>
                        <div>
                            <input type="number" id="long-break-time" class="neumorphic-inset w-full p-2 mb-2" value="15" min="1" max="60">
                            <button class="pomodoro-type neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold" data-type="longBreak">Long Break</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Microblog Section -->
            <div id="microblog-section" class="hidden space-y-6">
                <div class="neumorphic p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-600">Microblog</h3>
                    <div id="post-form" class="mb-4">
                        <textarea id="post-content" class="neumorphic-inset w-full p-2 mb-2" rows="3" placeholder="Share your thoughts..."></textarea>
                        <div class="flex justify-between items-center">
                            <div id="mood-selector" class="space-x-2">
                                <button class="mood-emoji" data-mood="happy">üòä</button>
                                <button class="mood-emoji" data-mood="sad">üò¢</button>
                                <button class="mood-emoji" data-mood="excited">üòÉ</button>
                                <button class="mood-emoji" data-mood="tired">üò¥</button>
                                <button class="mood-emoji" data-mood="neutral">üòê</button>
                            </div>
                            <button id="submit-post" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Post</button>
                        </div>
                    </div>
                    <div id="posts-container" class="space-y-4"></div>
                </div>
            </div>

            <!-- Teacher's Microblog View -->
            <div id="teacher-microblog-view" class="hidden space-y-6">
                <div class="neumorphic p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-600">Student Microblogs</h3>
                    <select id="student-microblog-select" class="neumorphic-inset w-full p-2 mb-4"></select>
                    <div id="teacher-posts-container" class="space-y-4"></div>
                </div>
            </div>
            
            <!-- Audio alert for timer -->
            <audio id="timer-audio" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3"></audio>
            
            <!-- Relatedness Mode -->
            <div id="relatedness-mode" class="hidden space-y-8">
                <h3 class="text-2xl font-semibold text-center text-indigo-600 mb-6">Relatedness Mode</h3>

                <!-- Team Leaderboard -->
                <div id="team-leaderboard" class="neumorphic p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-600">Team Leaderboard</h3>
                    <ul id="team-leaderboard-list" class="space-y-2"></ul>
                </div>

                <!-- Team Management (Visible to Teachers Only) -->
                <div id="team-management" class="hidden space-y-6">
                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Team Management</h3>
                        <select id="student-group-list" class="neumorphic-inset w-full p-2 mb-4"></select>
                        <input type="text" id="team-name" placeholder="Enter Team Name" class="neumorphic-inset w-full p-2 mb-4" />
                        <button onclick="assignTeam()" class="neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold">Assign to Team</button>
                    </div>
                    <div id="teams-list" class="neumorphic p-6"></div>

                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Award Points to Teams</h3>
                        <select id="team-select" class="neumorphic-inset w-full p-2 mb-4"></select>
                        <div class="point-buttons grid grid-cols-2 gap-4">
                            <button onclick="awardTeamPoints(10)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+10xp</button>
                            <button onclick="awardTeamPoints(20)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+20xp</button>
                            <button onclick="awardTeamPoints(50)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+50xp</button>
                            <button onclick="awardTeamPoints(100)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+100xp</button>
                        </div>
                    </div>
                </div>

                <!-- Student Team Information (Visible to Students Only) -->
                <div id="student-team-info" class="hidden space-y-6">
                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Your Team: <span id="student-team-name" class="text-indigo-800"></span></h3>
                        <ul id="student-team-members" class="list-disc list-inside space-y-2"></ul>
                    </div>

                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Team Messages</h3>
                        <div id="student-messages-list" class="space-y-4 mb-4"></div>
                        <input type="text" id="team-message-input" placeholder="Enter your message" class="neumorphic-inset w-full p-2 mb-4" />
                        <button onclick="sendMessage()" class="neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lessons Section -->
        <div id="lessons-section" class="hidden space-y-8">
            <h3 class="text-2xl font-semibold text-center text-indigo-600 mb-6">Lessons</h3>
            <div id="lessons-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- Lesson Management Section (Visible to Teachers Only) -->
        <div id="lesson-management" class="hidden space-y-8">
            <h3 class="text-2xl font-semibold text-center text-indigo-600 mb-6">Lesson Management</h3>
            <button onclick="showAddLessonForm()" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Add New Lesson</button>
            <div id="add-lesson-form" class="hidden space-y-4">
                <input type="text" id="lesson-title" placeholder="Lesson Title (required)" class="neumorphic-inset w-full p-2" required>
                <input type="text" id="lesson-task" placeholder="Lesson Task (optional)" class="neumorphic-inset w-full p-2">
                <div id="lesson-editor" class="neumorphic-inset w-full p-2 h-32"></div>
                <input type="file" id="lesson-image" accept="image/*" class="neumorphic-inset w-full p-2">
                <div id="lesson-image-preview-container" class="hidden mt-2">
                    <img id="lesson-image-preview" class="max-w-full h-auto" alt="Image preview" />
                </div>
                <input type="file" id="lesson-pdf" accept=".pdf" class="neumorphic-inset w-full p-2">
                <span id="lesson-pdf-label" class="text-sm text-gray-600"></span>
                <input type="text" id="lesson-link" placeholder="External Link" class="neumorphic-inset w-full p-2">
                <button onclick="saveLesson()" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Save Lesson</button>
            </div>
            <div id="lessons-management-list" class="space-y-4"></div>
        </div>
    </div>
</div>

<!-- Lesson Modal -->
<div id="lesson-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
    <div class="bg-white w-full h-full max-w-5xl mx-auto p-8 rounded-lg shadow-lg relative overflow-auto">
        <button onclick="closeLessonModal()" class="absolute top-4 right-4 text-gray-600 text-2xl font-bold">&times;</button>
        <h2 id="modal-lesson-title" class="text-2xl font-semibold mb-4 text-indigo-600"></h2>
        <div id="modal-lesson-task" class="text-lg mb-4"></div>
        <div id="modal-lesson-content" class="mb-4"></div>
        <div class="flex justify-center mb-4">
            <img id="modal-lesson-image" class="max-w-full h-auto rounded-lg" alt="Lesson Image" />
        </div>
        <a id="modal-lesson-pdf" href="#" target="_blank" class="block mb-2 text-blue-600 hover:underline">Download PDF</a>
        <a id="modal-lesson-link" href="#" target="_blank" class="block text-blue-600 hover:underline">Visit Link</a>
    </div>
</div>

<!-- Include Quill library -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script type="module">
    // Firebase configuration and initialization
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getDatabase, ref, set, get, update, push, remove, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";
import { sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyCYMlv_m2BcTrhm60hLroWVs0W_9SHSVfQ",
    authDomain: "gamification-app-856a4.firebaseapp.com",
    databaseURL: "https://gamification-app-856a4-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "gamification-app-856a4",
    storageBucket: "gamification-app-856a4.appspot.com",
    messagingSenderId: "966888657590",
    appId: "1:966888657590:web:98f5990d1c933f8cbc0c17",
    measurementId: "G-QVK4E2GD51"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const storage = getStorage(app);

// Login function
window.login = async function() {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;

    try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        console.log("Login successful", userCredential.user);
        loadDashboard(userCredential.user);
    } catch (error) {
        console.error("Login failed", error);
        alert("Login failed: " + error.message);
    }
}

window.showLoginForm = function() {
    document.getElementById('login-container').classList.remove('hidden');
    document.getElementById('register-container').classList.add('hidden');
    document.getElementById('auth-title').textContent = 'Login';
};

window.showRegisterForm = function() {
    document.getElementById('login-container').classList.add('hidden');
    document.getElementById('register-container').classList.remove('hidden');
    document.getElementById('auth-title').textContent = 'Register';
};
// Show forgot password form
window.showForgotPasswordForm = function() {
    document.getElementById('login-container').classList.add('hidden');
    document.getElementById('register-container').classList.add('hidden');
    document.getElementById('forgot-password-container').classList.remove('hidden');
    document.getElementById('auth-title').textContent = 'Reset Password';
}

let selectedGamificationMode = '';

window.toggleGamificationMode = function() {
    const roleSelect = document.getElementById('register-role');
    const gamificationModeSelect = document.getElementById('register-gamification-mode');
    
    if (roleSelect.value === 'teacher') {
        gamificationModeSelect.classList.remove('hidden');
    } else {
        gamificationModeSelect.classList.add('hidden');
        gamificationModeSelect.value = ''; // Reset the selection
    }
}

window.selectGamificationMode = function(mode) {
    selectedGamificationMode = mode;
    console.log('Selected gamification mode:', mode); // Debugging line
};

window.resetPassword = async function() {
    const email = document.getElementById('reset-email').value;

    if (!email) {
        alert('Please enter your email address');
        return;
    }

    try {
        await sendPasswordResetEmail(auth, email);
        alert('Password reset email sent. Please check your inbox.');
        showLoginForm();
    } catch (error) {
        console.error('Password reset failed:', error);
        alert('Password reset failed: ' + error.message);
    }
}

window.register = async function() {
    const name = document.getElementById('register-name').value;
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const schoolCode = document.getElementById('register-school-code').value;
    const role = document.getElementById('register-role').value;
    const gamificationMode = document.getElementById('register-gamification-mode').value;

    if (!name || !email || !password || !schoolCode || !role) {
        alert('Please fill in all required fields');
        return;
    }

    if (role === 'teacher' && !gamificationMode) {
        alert('Please select a gamification mode');
        return;
    }

    try {
        // Create user
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Check if school exists
        const schoolRef = ref(db, `schools/${schoolCode}`);
        const schoolSnapshot = await get(schoolRef);

        if (!schoolSnapshot.exists() && role === 'teacher') {
            // Create new school if it doesn't exist and user is a teacher
            await set(schoolRef, {
                gamificationMode: gamificationMode
            });
        }

        let assignedGamificationMode = gamificationMode;
        if (role === 'student') {
            // Get the gamification mode for the student's school
            if (schoolSnapshot.exists()) {
                assignedGamificationMode = schoolSnapshot.val().gamificationMode;
            } else {
                alert('School code is not valid for students.');
                return;
            }
        }

        // Save user data
        const userData = {
            email: email,
            fullName: name,
            role: role,
            schoolCode: schoolCode,
            gamificationMode: assignedGamificationMode // Assign the mode
        };

        await set(ref(db, `users/${user.uid}`), userData);

        console.log('User registered successfully:', user.uid);
        alert('Registration successful!');
        showLoginForm();
    } catch (error) {
        console.error('Error during registration:', error);
        alert('Registration failed: ' + error.message);
    }
};

// Add this to ensure the gamification mode container is hidden initially
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('gamification-mode-container').style.display = 'none';
    console.log('DOM loaded, gamification mode container hidden'); // Debugging line
});
// Load dashboard
async function loadDashboard(user) {
    try {
        const userRef = ref(db, 'users/' + user.uid);
        const userSnapshot = await get(userRef);
        if (userSnapshot.exists()) {
            const userData = userSnapshot.val();

            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('sidebar').style.display = 'flex';
            document.getElementById('main-content').style.display = 'block';

            document.getElementById('user-name').textContent = userData.fullName;
            document.getElementById('user-role').textContent = userData.role;
            document.getElementById('gamification-text').textContent = userData.gamificationMode;

            // Update sidebar content based on role and gamification mode
            updateSidebarContent(userData.role, userData.gamificationMode);

            // Load specific content based on role and gamification mode
            loadSpecificContent(userData);
        } else {
            alert('No user data available');
        }
    } catch (error) {
        console.error('Failed to load dashboard:', error);
    }
}

// Update sidebar content
function updateSidebarContent(role, mode) {
    const sidebarContent = document.getElementById('sidebar-content');
    sidebarContent.innerHTML = '';

    const commonItems = `
        <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showDashboard()">Dashboard</div>
        <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showLessons()">Lessons</div>
    `;

    let modeSpecificItems = '';
    let teacherActions = '';

    if (mode === 'competence') {
        modeSpecificItems = `
            <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showLeaderboard()">Leaderboard</div>
        `;
        if (role === 'teacher') {
            teacherActions = `
                <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showLessonManagement()">Manage Lessons</div>
                <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showPointsAward()">Award Points</div>
                <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showResetGamification()">Reset Gamification</div>
            `;
        } else {
            modeSpecificItems += `
                <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showProgress()">My Progress</div>
            `;
        }
    } else if (mode === 'autonomy') {
        modeSpecificItems = `
            <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showThemeSelection()">Theme Selection</div>
            <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showAvatarCustomization()">Avatar Customization</div>
            <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showPomodoro()">Pomodoro Timer</div>
            <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showMicroblog()">My Microblog</div>
        `;
        if (role === 'teacher') {
            teacherActions = `
                <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showLessonManagement()">Manage Lessons</div>
                <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showStudentMicroblogs()">Student Microblogs</div>
            `;
        }
    } else if (mode === 'relatedness') {
        modeSpecificItems = `
            <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showTeamLeaderboard()">Team Leaderboard</div>
        `;
        if (role === 'teacher') {
            teacherActions = `
                <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showLessonManagement()">Manage Lessons</div>
                <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showTeamManagement()">Manage Teams</div>
                <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showResetTeamGamification()">Reset Team Gamification</div>
            `;
        } else {
            modeSpecificItems += `
                <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showTeamInfo()">My Team</div>
            `;
        }
    }

    sidebarContent.innerHTML = `
        ${commonItems}
        <div class="mb-4"></div>
        <h3 class="text-white text-lg font-semibold mb-2">${mode.charAt(0).toUpperCase() + mode.slice(1)} Mode</h3>
        ${modeSpecificItems}
    `;

    if (role === 'teacher') {
        sidebarContent.innerHTML += `
            <div class="mt-6">
                <h4 class="text-lg font-semibold mb-2 text-white">Teacher Actions</h4>
                <div class="space-y-2">
                    ${teacherActions}
                </div>
            </div>
        `;
    }
}
// Load specific content based on user role and gamification mode
function loadSpecificContent(userData) {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = ''; // Clear existing content

    if (userData.role === 'teacher') {
        loadTeacherDashboard(userData);
    } else {
        loadStudentDashboard(userData);
    }
}

// Load teacher dashboard
function loadTeacherDashboard(userData) {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Welcome, ${userData.fullName}!</h2>
        <p>You are logged in as a teacher in ${userData.gamificationMode} mode.</p>
        <div id="teacher-actions" class="mt-8">
            <h3 class="text-xl font-semibold mb-4">Teacher Actions</h3>
            <button onclick="showLessonManagement()" class="neumorphic-button mb-4">Manage Lessons</button>
            ${userData.gamificationMode === 'competence' ? '<button onclick="showPointsAward()" class="neumorphic-button mb-4">Award Points</button>' : ''}
            ${userData.gamificationMode === 'relatedness' ? '<button onclick="showTeamManagement()" class="neumorphic-button mb-4">Manage Teams</button>' : ''}
            ${userData.gamificationMode === 'autonomy' ? '<button onclick="showStudentMicroblogs()" class="neumorphic-button mb-4">View Student Microblogs</button>' : ''}
        </div>
    `;
}

// Load student dashboard
function loadStudentDashboard(userData) {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Welcome, ${userData.fullName}!</h2>
        <p>You are logged in as a student in ${userData.gamificationMode} mode.</p>
        <div id="student-actions" class="mt-8">
            <h3 class="text-xl font-semibold mb-4">Student Actions</h3>
            <button onclick="showLessons()" class="neumorphic-button mb-4">View Lessons</button>
            ${userData.gamificationMode === 'competence' ? '<button onclick="showProgress()" class="neumorphic-button mb-4">View Progress</button>' : ''}
            ${userData.gamificationMode === 'relatedness' ? '<button onclick="showTeamInfo()" class="neumorphic-button mb-4">View Team Info</button>' : ''}
            ${userData.gamificationMode === 'autonomy' ? '<button onclick="showMicroblog()" class="neumorphic-button mb-4">My Microblog</button>' : ''}
        </div>
    `;
}

// Show login form
window.showLogin = function() {
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('register-form').style.display = 'none';
    document.getElementById('auth-title').textContent = 'Login';
}

// Show register form
window.showRegister = function() {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('register-form').style.display = 'block';
    document.getElementById('auth-title').textContent = 'Register';
}

window.showLoginForm = function() {
    document.getElementById('login-container').classList.remove('hidden');
    document.getElementById('register-container').classList.add('hidden');
    document.getElementById('forgot-password-container').classList.add('hidden');
    document.getElementById('auth-title').textContent = 'Login';
};

// Toggle gamification mode selection
window.toggleGamificationMode = function() {
    const roleSelect = document.getElementById('register-role');
    const gamificationModeSelect = document.getElementById('register-gamification-mode');
    
    if (roleSelect.value === 'teacher') {
        gamificationModeSelect.style.display = 'block';
    } else {
        gamificationModeSelect.style.display = 'none';
        gamificationModeSelect.value = ''; // Reset the selection
    }
}

// Logout function
window.logout = function() {
    signOut(auth).then(() => {
        document.getElementById('auth-container').style.display = 'flex';
        document.getElementById('sidebar').style.display = 'none';
        document.getElementById('main-content').style.display = 'none';
    }).catch((error) => {
        console.error('Failed to logout:', error);
    });
}

// Show dashboard
window.showDashboard = function() {
    const user = auth.currentUser;
    if (user) {
        loadDashboard(user);
    }
}

// Show lessons
window.showLessons = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = '<h2 class="text-2xl font-bold mb-4">Lessons</h2><div id="lessons-list"></div>';
    loadLessons();
}

// Load lessons
async function loadLessons() {
    try {
        const lessonsRef = ref(db, 'lessons');
        const snapshot = await get(lessonsRef);
        const lessonsList = document.getElementById('lessons-list');
        lessonsList.innerHTML = ''; // Clear the list first

        snapshot.forEach((childSnapshot) => {
            const lessonData = childSnapshot.val();
            const lessonCard = document.createElement('div');
            lessonCard.className = 'neumorphic p-4 mb-4';
            lessonCard.innerHTML = `
                <h3 class="text-xl font-semibold mb-2">${lessonData.title}</h3>
                <p>${lessonData.task || 'No task specified.'}</p>
                <button onclick="openLessonModal('${childSnapshot.key}')" class="neumorphic-button mt-2">View Lesson</button>
            `;
            lessonsList.appendChild(lessonCard);
        });
    } catch (error) {
        console.error('Failed to load lessons:', error);
    }
}

// Open lesson modal

// Update openLessonModal function
// Update openLessonModal function
window.openLessonModal = async function(lessonId) {
    try {
        const lessonRef = ref(db, `lessons/${lessonId}`);
        const snapshot = await get(lessonRef);
        if (snapshot.exists()) {
            const lessonData = snapshot.val();
            const modalContent = `
                <div class="lesson-container">
                    <div class="lesson-content">
                        <h2 id="modal-lesson-title" class="text-2xl font-semibold mb-4 text-indigo-600">${lessonData.title}</h2>
                        <div id="modal-lesson-task" class="text-lg mb-4">${lessonData.task || ''}</div>
                        <div id="modal-lesson-content" class="mb-4">${lessonData.content || ''}</div>
                    </div>
                    <div class="lesson-resources mt-4">
                        <h3 class="text-xl font-semibold mb-2">Resources</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${lessonData.imageUrls ? lessonData.imageUrls.map((url, index) => `
                                <div class="resource-item">
                                    <img src="${url}" class="w-full h-64 object-cover rounded-lg cursor-pointer shadow-lg hover:shadow-xl transition-shadow duration-300" alt="Lesson Image ${index + 1}" onclick="openImageModal('${url}')">
                                    <p class="text-sm text-center mt-2">Image ${index + 1}</p>
                                </div>
                            `).join('') : ''}
                            ${lessonData.pdfUrls ? lessonData.pdfUrls.map((url, index) => `
                                <div class="resource-item bg-gradient-to-br from-blue-100 to-indigo-100 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden transform hover:-translate-y-1">
                                    <div class="h-48 flex items-center justify-center p-4">
                                        <svg class="w-24 h-24 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                    </div>
                                    <div class="p-4 bg-white bg-opacity-80 backdrop-filter backdrop-blur-lg">
                                        <h4 class="text-lg font-semibold mb-2 text-indigo-700">PDF Resource ${index + 1}</h4>
                                        <button onclick="openPdfModal('${url}')" class="w-full bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition-colors duration-300 shadow-md hover:shadow-lg">View PDF</button>
                                    </div>
                                </div>
                            `).join('') : ''}
                            ${lessonData.links ? lessonData.links.map((link, index) => `
                                <div class="resource-item bg-gradient-to-br from-green-100 to-teal-100 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden transform hover:-translate-y-1">
                                    <div class="h-48 flex items-center justify-center p-4">
                                        <svg class="w-24 h-24 text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                                    </div>
                                    <div class="p-4 bg-white bg-opacity-80 backdrop-filter backdrop-blur-lg">
                                        <h4 class="text-lg font-semibold mb-2 text-teal-700">External Link ${index + 1}</h4>
                                        <button onclick="openLinkModal('${link}')" class="w-full bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition-colors duration-300 shadow-md hover:shadow-lg">Visit Link</button>
                                    </div>
                                </div>
                            `).join('') : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('lesson-modal').innerHTML = `
                <div class="bg-white w-full h-full max-w-5xl mx-auto p-8 rounded-lg shadow-lg relative overflow-auto">
                    <button onclick="closeLessonModal()" class="absolute top-4 right-4 text-gray-600 text-2xl font-bold">&times;</button>
                    ${modalContent}
                </div>
            `;
            document.getElementById('lesson-modal').style.display = 'flex';
            document.getElementById('lesson-modal').style.zIndex = '40';
        } else {
            alert('Lesson not found');
        }
    } catch (error) {
        console.error('Failed to load lesson:', error);
    }
}

// Update openImageModal function to allow scrolling
window.openImageModal = function(url) {
    const imageModal = document.createElement('div');
    imageModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
    imageModal.style.zIndex = '50';
    imageModal.innerHTML = `
        <div class="relative max-w-[95vw] max-h-[95vh] overflow-auto">
            <img src="${url}" class="max-w-none h-auto" alt="Full size image">
            <button onclick="this.closest('.fixed').classList.add('opacity-0'); setTimeout(() => this.closest('.fixed').remove(), 300)" class="absolute top-4 right-4 text-white text-2xl font-bold bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center">&times;</button>
        </div>
    `;
    document.body.appendChild(imageModal);
}

// Update openPdfModal function
window.openPdfModal = function(url) {
    const pdfModal = document.createElement('div');
    pdfModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
    pdfModal.style.zIndex = '50';
    pdfModal.innerHTML = `
        <div class="relative w-[95vw] h-[95vh] bg-white rounded-lg overflow-hidden">
            <iframe src="${url}" class="w-full h-full rounded-lg"></iframe>
            <button onclick="this.closest('.fixed').classList.add('opacity-0'); setTimeout(() => this.closest('.fixed').remove(), 300)" class="absolute top-4 right-4 text-gray-600 text-2xl font-bold bg-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg">&times;</button>
        </div>
    `;
    document.body.appendChild(pdfModal);
}

// Update openLinkModal function
window.openLinkModal = function(url) {
    const linkModal = document.createElement('div');
    linkModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
    linkModal.style.zIndex = '50';
    linkModal.innerHTML = `
        <div class="relative w-[95vw] h-[95vh] bg-white rounded-lg overflow-hidden">
            <iframe src="${url}" class="w-full h-full rounded-lg" onload="this.style.display='block'" onerror="this.style.display='none'; document.getElementById('fallback-message').style.display='flex'"></iframe>
            <div id="fallback-message" class="absolute inset-0 flex-col items-center justify-center bg-white" style="display: none;">
                <p class="text-xl mb-4">Unable to load the content in the app.</p>
                <a href="${url}" target="_blank" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors duration-300">Open in New Tab</a>
            </div>
            <button onclick="this.closest('.fixed').classList.add('opacity-0'); setTimeout(() => this.closest('.fixed').remove(), 300)" class="absolute top-4 right-4 text-gray-600 text-2xl font-bold bg-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg">&times;</button>
        </div>
    `;
    document.body.appendChild(linkModal);
}
// Close lesson modal
window.closeLessonModal = function() {
    document.getElementById('lesson-modal').style.display = 'none';
}

// Show lesson management section
window.showLessonManagement = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Lesson Management</h2>
        <button onclick="showAddLessonForm()" class="neumorphic-button mb-4">Add New Lesson</button>
        <div id="add-lesson-form" class="hidden">
            <input type="text" id="lesson-title" placeholder="Lesson Title" class="neumorphic-inset w-full p-2 mb-2">
            <input type="text" id="lesson-task" placeholder="Lesson Task" class="neumorphic-inset w-full p-2 mb-2">
            <div id="lesson-editor" class="neumorphic-inset w-full p-2 mb-2 h-32"></div>
            <div id="image-uploads">
                <input type="file" class="lesson-image neumorphic-inset w-full p-2 mb-2" accept="image/*" multiple>
            </div>
            <button onclick="addImageUpload()" class="neumorphic-button mb-2">Add Another Image</button>
            <div id="pdf-uploads">
                <input type="file" class="lesson-pdf neumorphic-inset w-full p-2 mb-2" accept=".pdf" multiple>
            </div>
            <button onclick="addPdfUpload()" class="neumorphic-button mb-2">Add Another PDF</button>
            <div id="link-inputs">
                <input type="text" class="lesson-link neumorphic-inset w-full p-2 mb-2" placeholder="External Link">
            </div>
            <button onclick="addLinkInput()" class="neumorphic-button mb-2">Add Another Link</button>
            <button onclick="saveLesson()" class="neumorphic-button">Save Lesson</button>
        </div>
        <div id="lessons-management-list"></div>
    `;
    loadLessonsForManagement();
    initQuillEditor();
}

// Add functions to dynamically add more upload fields
window.addImageUpload = function() {
    const imageUploads = document.getElementById('image-uploads');
    const newUpload = document.createElement('input');
    newUpload.type = 'file';
    newUpload.className = 'lesson-image neumorphic-inset w-full p-2 mb-2';
    newUpload.accept = 'image/*';
    newUpload.multiple = true;
    imageUploads.appendChild(newUpload);
}

window.addPdfUpload = function() {
    const pdfUploads = document.getElementById('pdf-uploads');
    const newUpload = document.createElement('input');
    newUpload.type = 'file';
    newUpload.className = 'lesson-pdf neumorphic-inset w-full p-2 mb-2';
    newUpload.accept = '.pdf';
    newUpload.multiple = true;
    pdfUploads.appendChild(newUpload);
}

window.addLinkInput = function() {
    const linkInputs = document.getElementById('link-inputs');
    const newInput = document.createElement('input');
    newInput.type = 'text';
    newInput.className = 'lesson-link neumorphic-inset w-full p-2 mb-2';
    newInput.placeholder = 'External Link';
    linkInputs.appendChild(newInput);
}

// Initialize Quill editor
function initQuillEditor() {
    const quill = new Quill('#lesson-editor', {
        theme: 'snow'
    });
}

// Show add lesson form
window.showAddLessonForm = function() {
    document.getElementById('add-lesson-form').style.display = 'block';
}

// Save lesson
window.saveLesson = async function() {
    const title = document.getElementById('lesson-title').value;
    const task = document.getElementById('lesson-task').value;
    const content = document.querySelector('.ql-editor').innerHTML;
    const imageFiles = Array.from(document.querySelectorAll('.lesson-image')).flatMap(input => Array.from(input.files));
    const pdfFiles = Array.from(document.querySelectorAll('.lesson-pdf')).flatMap(input => Array.from(input.files));
    const links = Array.from(document.querySelectorAll('.lesson-link')).map(input => input.value).filter(link => link.trim() !== '');

    if (!title) {
        alert('Please enter a lesson title');
        return;
    }

    try {
        const newLessonRef = push(ref(db, 'lessons'));
        const lessonData = {
            title: title,
            task: task,
            content: content,
            links: links
        };

        // Upload images
        const imageUrls = await Promise.all(imageFiles.map(async (file, index) => {
            const imageRef = storageRef(storage, `lessons/${newLessonRef.key}/images/image_${index}`);
            await uploadBytes(imageRef, file);
            return getDownloadURL(imageRef);
        }));
        lessonData.imageUrls = imageUrls;

        // Upload PDFs
        const pdfUrls = await Promise.all(pdfFiles.map(async (file, index) => {
            const pdfRef = storageRef(storage, `lessons/${newLessonRef.key}/pdfs/pdf_${index}`);
            await uploadBytes(pdfRef, file);
            return getDownloadURL(pdfRef);
        }));
        lessonData.pdfUrls = pdfUrls;

        await set(newLessonRef, lessonData);
        alert('Lesson saved successfully!');
        document.getElementById('add-lesson-form').style.display = 'none';
        loadLessonsForManagement();
    } catch (error) {
        console.error('Failed to save lesson:', error);
        alert('Failed to save lesson. Please try again.');
    }
}
// Load lessons for management
async function loadLessonsForManagement() {
    try {
        const lessonsRef = ref(db, 'lessons');
        const snapshot = await get(lessonsRef);
        const lessonsList = document.getElementById('lessons-management-list');
        lessonsList.innerHTML = ''; // Clear the list first

        snapshot.forEach((childSnapshot) => {
            const lessonData = childSnapshot.val();
            const lessonCard = document.createElement('div');
            lessonCard.className = 'neumorphic p-4 mb-4';
            lessonCard.innerHTML = `
                <h3 class="text-xl font-semibold mb-2">${lessonData.title}</h3>
                <p>${lessonData.task || 'No task specified.'}</p>
                <button onclick="editLesson('${childSnapshot.key}')" class="neumorphic-button mt-2 mr-2">Edit</button>
                <button onclick="deleteLesson('${childSnapshot.key}')" class="neumorphic-button mt-2">Delete</button>
            `;
            lessonsList.appendChild(lessonCard);
        });
    } catch (error) {
        console.error('Failed to load lessons for management:', error);
    }
}

// Edit lesson
window.editLesson = async function(lessonId) {
    try {
        const lessonRef = ref(db, `lessons/${lessonId}`);
        const snapshot = await get(lessonRef);
        if (snapshot.exists()) {
            const lessonData = snapshot.val();
            document.getElementById('lesson-title').value = lessonData.title;
            document.getElementById('lesson-task').value = lessonData.task || '';
            document.querySelector('.ql-editor').innerHTML = lessonData.content || '';
            
            // Clear existing fields
            document.getElementById('image-uploads').innerHTML = '';
            document.getElementById('pdf-uploads').innerHTML = '';
            document.getElementById('link-inputs').innerHTML = '';
            
            // Add existing images
            if (lessonData.imageUrls) {
                lessonData.imageUrls.forEach(() => addImageUpload());
            }
            
            // Add existing PDFs
            if (lessonData.pdfUrls) {
                lessonData.pdfUrls.forEach(() => addPdfUpload());
            }
            
            // Add existing links
            if (lessonData.links) {
                lessonData.links.forEach(link => {
                    addLinkInput();
                    document.querySelector('.lesson-link:last-child').value = link;
                });
            }
            
            document.getElementById('add-lesson-form').style.display = 'block';
            window.currentEditingLessonId = lessonId;
        } else {
            alert('Lesson not found');
        }
    } catch (error) {
        console.error('Failed to load lesson for editing:', error);
    }
}

// Delete lesson
window.deleteLesson = async function(lessonId) {
    if (confirm('Are you sure you want to delete this lesson?')) {
        try {
            await remove(ref(db, `lessons/${lessonId}`));
            alert('Lesson deleted successfully!');
            loadLessonsForManagement();
        } catch (error) {
            console.error('Failed to delete lesson:', error);
            alert('Failed to delete lesson. Please try again.');
        }
    }
}

// Competence Mode Functions

// Show leaderboard
window.showLeaderboard = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = '<h2 class="text-2xl font-bold mb-4">Leaderboard</h2><div id="leaderboard-list"></div>';
    loadLeaderboard();
}

// Load leaderboard
function loadLeaderboard() {
    const user = auth.currentUser;
    const userRef = ref(db, `users/${user.uid}`);
    get(userRef).then((userSnapshot) => {
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;
        const leaderboardRef = ref(db, `schools/${schoolCode}/leaderboard`);
        
        onValue(leaderboardRef, (snapshot) => {
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '';

            const leaderboardData = [];
            snapshot.forEach((childSnapshot) => {
                leaderboardData.push({
                    uid: childSnapshot.key,
                    ...childSnapshot.val()
                });
            });

            leaderboardData.sort((a, b) => b.points - a.points);

            leaderboardData.forEach((entry, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'neumorphic p-4 mb-4';
                listItem.innerHTML = `
                    <span class="font-bold">#${index + 1}</span>
                    <span class="ml-4">${entry.name}</span>
                    <span class="float-right">${entry.points} points</span>
                    <div class="mt-2">
                        ${entry.badges ? entry.badges.map(badge => `<span class="inline-block bg-blue-200 rounded-full px-3 py-1 text-sm font-semibold text-blue-700 mr-2 mb-2">${badge}</span>`).join('') : ''}
                    </div>
                `;
                leaderboardList.appendChild(listItem);
            });
        });
    });
}
// Show points award (for teachers)
// ... existing code ...

// Update the showPointsAward function
window.showPointsAward = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Award Points and Badges</h2>
        <select id="student-list" class="neumorphic-inset w-full p-2 mb-4"></select>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <button onclick="awardPoints(10)" class="neumorphic-button">+10 points</button>
            <button onclick="awardPoints(-10)" class="neumorphic-button">-10 points</button>
            <button onclick="awardPoints(20)" class="neumorphic-button">+20 points</button>
            <button onclick="awardPoints(-20)" class="neumorphic-button">-20 points</button>
            <button onclick="awardPoints(50)" class="neumorphic-button">+50 points</button>
            <button onclick="awardPoints(-50)" class="neumorphic-button">-50 points</button>
            <button onclick="awardPoints(100)" class="neumorphic-button">+100 points</button>
            <button onclick="awardPoints(-100)" class="neumorphic-button">-100 points</button>
        </div>
        <h3 class="text-xl font-bold mb-4">Award Badges</h3>
        <div class="grid grid-cols-3 gap-4">
            <button onclick="awardBadge('Grammar Master')" class="badge-button bg-blue-100 hover:bg-blue-200">
                <span class="emoji">üìö</span>
                <span class="badge-name">Grammar Master</span>
            </button>
            <button onclick="awardBadge('Vocabulary Virtuoso')" class="badge-button bg-green-100 hover:bg-green-200">
                <span class="emoji">üìñ</span>
                <span class="badge-name">Vocabulary Virtuoso</span>
            </button>
            <button onclick="awardBadge('Pronunciation Pro')" class="badge-button bg-yellow-100 hover:bg-yellow-200">
                <span class="emoji">üó£Ô∏è</span>
                <span class="badge-name">Pronunciation Pro</span>
            </button>
            <button onclick="awardBadge('Writing Wizard')" class="badge-button bg-purple-100 hover:bg-purple-200">
                <span class="emoji">‚úçÔ∏è</span>
                <span class="badge-name">Writing Wizard</span>
            </button>
            <button onclick="awardBadge('Reading Champion')" class="badge-button bg-red-100 hover:bg-red-200">
                <span class="emoji">üìò</span>
                <span class="badge-name">Reading Champion</span>
            </button>
            <button onclick="awardBadge('Listening Legend')" class="badge-button bg-indigo-100 hover:bg-indigo-200">
                <span class="emoji">üëÇ</span>
                <span class="badge-name">Listening Legend</span>
            </button>
            <button onclick="awardBadge('Speaking Star')" class="badge-button bg-pink-100 hover:bg-pink-200">
                <span class="emoji">üé§</span>
                <span class="badge-name">Speaking Star</span>
            </button>
            <button onclick="awardBadge('Idiom Expert')" class="badge-button bg-teal-100 hover:bg-teal-200">
                <span class="emoji">üß†</span>
                <span class="badge-name">Idiom Expert</span>
            </button>
            <button onclick="awardBadge('Tense Tamer')" class="badge-button bg-orange-100 hover:bg-orange-200">
                <span class="emoji">‚è≥</span>
                <span class="badge-name">Tense Tamer</span>
            </button>
            <button onclick="awardBadge('Punctuation Perfectionist')" class="badge-button bg-gray-100 hover:bg-gray-200">
                <span class="emoji">üîç</span>
                <span class="badge-name">Punctuation Perfectionist</span>
            </button>
            <button onclick="awardBadge('Conversation Connoisseur')" class="badge-button bg-blue-100 hover:bg-blue-200">
                <span class="emoji">üí¨</span>
                <span class="badge-name">Conversation Connoisseur</span>
            </button>
            <button onclick="awardBadge('Essay Enthusiast')" class="badge-button bg-green-100 hover:bg-green-200">
                <span class="emoji">üìù</span>
                <span class="badge-name">Essay Enthusiast</span>
            </button>
        </div>
    `;
    loadStudentList();
}

// Update the showTeamManagement function
window.showTeamManagement = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Team Management</h2>
        <div class="neumorphic p-4 mb-4">
            <h3 class="text-xl font-bold mb-2">Create Team</h3>
            <input type="text" id="team-name" placeholder="Team Name" class="w-full p-2 mb-2 neumorphic-inset">
            <button onclick="createTeam()" class="neumorphic-button p-2">Create Team</button>
        </div>
        <div class="neumorphic p-4 mb-4">
            <h3 class="text-xl font-bold mb-2">Assign Student to Team</h3>
            <select id="student-select" class="w-full p-2 mb-2 neumorphic-inset"></select>
            <select id="team-select" class="w-full p-2 mb-2 neumorphic-inset"></select>
            <button onclick="assignStudentToTeam()" class="neumorphic-button p-2">Assign Student</button>
        </div>
        <div class="neumorphic p-4 mb-4">
            <h3 class="text-xl font-bold mb-2">Award Points to Team</h3>
            <select id="team-points-select" class="w-full p-2 mb-2 neumorphic-inset"></select>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="awardTeamPoints(10)" class="neumorphic-button p-2">+10 Points</button>
                <button onclick="awardTeamPoints(-10)" class="neumorphic-button p-2">-10 Points</button>
                <button onclick="awardTeamPoints(20)" class="neumorphic-button p-2">+20 Points</button>
                <button onclick="awardTeamPoints(-20)" class="neumorphic-button p-2">-20 Points</button>
                <button onclick="awardTeamPoints(50)" class="neumorphic-button p-2">+50 Points</button>
                <button onclick="awardTeamPoints(-50)" class="neumorphic-button p-2">-50 Points</button>
                <button onclick="awardTeamPoints(100)" class="neumorphic-button p-2">+100 Points</button>
                <button onclick="awardTeamPoints(-100)" class="neumorphic-button p-2">-100 Points</button>
            </div>
        </div>
        <div class="neumorphic p-4 mb-4">
            <h3 class="text-xl font-bold mb-2">Delete Team</h3>
            <select id="delete-team-select" class="w-full p-2 mb-2 neumorphic-inset"></select>
            <button onclick="deleteTeam()" class="neumorphic-button p-2 bg-red-500 text-white">Delete Team</button>
        </div>
        <div id="teams-list"></div>
    `;
    loadTeamsAndStudents();
    loadTeamsForPointsAwarding();
    loadTeamsForDeletion();
}

// Update the awardTeamPoints function
window.awardTeamPoints = async function(points) {
    const teamSelect = document.getElementById('team-points-select');
    const selectedTeamName = teamSelect.value;

    if (!selectedTeamName) {
        alert('Please select a team first.');
        return;
    }

    try {
        const user = auth.currentUser;
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const teamRef = ref(db, `schools/${schoolCode}/teams/${selectedTeamName}`);
        const teamSnapshot = await get(teamRef);

        if (teamSnapshot.exists()) {
            const teamData = teamSnapshot.val();
            const newPoints = (teamData.points || 0) + points;

            await update(teamRef, { points: newPoints });
            alert(`Successfully ${points > 0 ? 'awarded' : 'deducted'} ${Math.abs(points)} points ${points > 0 ? 'to' : 'from'} ${selectedTeamName}!`);
            // The listener will automatically update the leaderboard
        } else {
            alert('Selected team not found.');
        }
    } catch (error) {
        console.error('Error awarding team points:', error);
        alert('Failed to update points. Please try again.');
    }
}

// ... rest of the existing code ...

window.showResetGamification = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Reset Gamification</h2>
        <div class="neumorphic p-6">
            <p class="mb-4">Warning: This action will reset all points, badges, and the leaderboard for all students in your school. This action cannot be undone.</p>
            <button onclick="confirmResetGamification()" class="neumorphic-button py-2 px-4 text-red-600 font-semibold">Reset All Gamification Data</button>
        </div>
    `;
}

window.confirmResetGamification = function() {
    if (confirm("Are you sure you want to reset all gamification data? This action cannot be undone.")) {
        resetGamificationData();
    }
}

async function resetGamificationData() {
    const user = auth.currentUser;
    try {
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        // Reset leaderboard
        await set(ref(db, `schools/${schoolCode}/leaderboard`), null);

        // Reset all students' points and badges
        const usersRef = ref(db, 'users');
        const snapshot = await get(usersRef);
        const updates = {};

        snapshot.forEach((childSnapshot) => {
            const studentData = childSnapshot.val();
            if (studentData.role === 'student' && studentData.schoolCode === schoolCode) {
                updates[`${childSnapshot.key}/points`] = 0;
                updates[`${childSnapshot.key}/badges`] = null;
            }
        });

        await update(usersRef, updates);

        alert('Gamification data has been reset successfully.');
    } catch (error) {
        console.error('Failed to reset gamification data:', error);
        alert('Failed to reset gamification data. Please try again.');
    }
}

// Load student list
async function loadStudentList() {
    try {
        const user = auth.currentUser;
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const usersRef = ref(db, 'users');
        const snapshot = await get(usersRef);
        const studentList = document.getElementById('student-list');
        studentList.innerHTML = '<option value="">Select a student</option>';

        snapshot.forEach((childSnapshot) => {
            const studentData = childSnapshot.val();
            if (studentData.role === 'student' && studentData.schoolCode === schoolCode) {
                const option = document.createElement('option');
                option.value = childSnapshot.key;
                option.textContent = studentData.fullName;
                studentList.appendChild(option);
            }
        });
    } catch (error) {
        console.error('Failed to load student list:', error);
    }
}

// Award points
window.awardPoints = async function(points) {
    const studentId = document.getElementById('student-list').value;
    if (!studentId) {
        alert('Please select a student');
        return;
    }

    try {
        const studentRef = ref(db, `users/${studentId}`);
        const studentSnapshot = await get(studentRef);
        const studentData = studentSnapshot.val();
        const newPoints = (studentData.points || 0) + points;

        await update(studentRef, { points: newPoints });

        const leaderboardRef = ref(db, `schools/${studentData.schoolCode}/leaderboard/${studentId}`);
        await set(leaderboardRef, {
            name: studentData.fullName,
            points: newPoints
        });

        alert(`Points updated for ${studentData.fullName}`);
    } catch (error) {
        console.error('Failed to award points:', error);
        alert('Failed to award points. Please try again.');
    }
}

// Award badges to students (for teachers)
window.awardBadge = async function(badgeName) {
    const studentId = document.getElementById('student-list').value;
    if (!studentId) {
        alert('Please select a student');
        return;
    }

    try {
        const studentRef = ref(db, `users/${studentId}`);
        const studentSnapshot = await get(studentRef);
        const studentData = studentSnapshot.val();

        let badges = studentData.badges || [];
        if (!badges.includes(badgeName)) {
            badges.push(badgeName);
            await update(studentRef, { badges: badges });

            // Update leaderboard with new badge
            const leaderboardRef = ref(db, `schools/${studentData.schoolCode}/leaderboard/${studentId}`);
            await update(leaderboardRef, { badges: badges });

            alert(`Badge "${badgeName}" awarded to ${studentData.fullName}`);
        } else {
            alert(`${studentData.fullName} already has the "${badgeName}" badge.`);
        }
    } catch (error) {
        console.error('Failed to award badge:', error);
        alert('Failed to award badge. Please try again.');
    }
}

// Show student progress
window.showProgress = function() {
    const user = auth.currentUser;
    const userRef = ref(db, `users/${user.uid}`);
    
    onValue(userRef, (snapshot) => {
        const userData = snapshot.val();
        const mainContent = document.getElementById('main-content');
        
        const level = Math.floor(userData.points / 100) + 1;
        const progress = (userData.points % 100);

        mainContent.innerHTML = `
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">My Progress</h2>
                
                <div class="flex items-center mb-4">
                    <div class="bg-blue-100 rounded-full p-3 mr-4">
                        <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Total Points</p>
                        <p class="text-2xl font-bold">${userData.points || 0}</p>
                    </div>
                </div>
                
                <div class="flex items-center mb-4">
                    <div class="bg-green-100 rounded-full p-3 mr-4">
                        <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Level</p>
                        <p class="text-2xl font-bold">${level}</p>
                    </div>
                </div>
                
                <div class="mb-2">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-blue-700">Progress to next level</span>
                        <span class="text-sm font-medium text-blue-700">${progress}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4">Badges</h2>
                
                <div id="badges-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
            </div>
        `;

        const badgesList = document.getElementById('badges-list');
        if (userData.badges && userData.badges.length > 0) {
            userData.badges.forEach(badge => {
                const badgeElement = document.createElement('div');
                badgeElement.className = 'bg-blue-100 rounded-lg p-4 flex flex-col items-center justify-center';
                badgeElement.innerHTML = `
                    <span class="text-4xl mb-2">${getBadgeEmoji(badge)}</span>
                    <span class="text-sm font-medium text-center">${badge}</span>
                `;
                badgesList.appendChild(badgeElement);
            });
        } else {
            badgesList.innerHTML = '<p class="col-span-full text-center text-gray-500">No badges earned yet.</p>';
        }
    });
}

// Helper function to get emoji for each badge
function getBadgeEmoji(badge) {
    const emojis = {
        'Grammar Master': 'üìö',
        'Vocabulary Virtuoso': 'üìñ',
        'Pronunciation Pro': 'üó£Ô∏è',
        'Writing Wizard': '‚úçÔ∏è',
        'Reading Champion': 'üìò',
        'Listening Legend': 'üëÇ',
        'Speaking Star': 'üé§',
        'Idiom Expert': 'üß†',
        'Tense Tamer': '‚è≥',
        'Punctuation Perfectionist': 'üîç',
        'Conversation Connoisseur': 'üí¨',
        'Essay Enthusiast': 'üìù'
    };
    return emojis[badge] || 'üèÖ'; // Default emoji if badge not found
}
// Autonomy Mode Functions

// Show theme selection
window.showThemeSelection = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Theme Selection</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <button onclick="changeTheme('default')" class="neumorphic-button p-4">Default</button>
            <button onclick="changeTheme('dark')" class="neumorphic-button p-4">Dark</button>
            <button onclick="changeTheme('light')" class="neumorphic-button p-4">Light</button>
            <button onclick="changeTheme('nature')" class="neumorphic-button p-4">Nature</button>
            <button onclick="changeTheme('ocean-breeze')" class="neumorphic-button p-4">Ocean Breeze</button>
            <button onclick="changeTheme('sunset-glow')" class="neumorphic-button p-4">Sunset Glow</button>
            <button onclick="changeTheme('forest-mist')" class="neumorphic-button p-4">Forest Mist</button>
            <button onclick="changeTheme('cosmic-purple')" class="neumorphic-button p-4">Cosmic Purple</button>
            <button onclick="changeTheme('citrus-burst')" class="neumorphic-button p-4">Citrus Burst</button>
            <button onclick="changeTheme('midnight-sky')" class="neumorphic-button p-4">Midnight Sky</button>
            <button onclick="changeTheme('cherry-blossom')" class="neumorphic-button p-4">Cherry Blossom</button>
            <button onclick="changeTheme('northern-lights')" class="neumorphic-button p-4">Northern Lights</button>
        </div>
    `;
}

// Change theme
window.changeTheme = async function(theme) {
    document.body.className = `theme-${theme}`;
    const user = auth.currentUser;
    try {
        await update(ref(db, `users/${user.uid}`), { theme: theme });
        alert('Theme updated successfully!');
    } catch (error) {
        console.error('Failed to update theme:', error);
    }
}

// Show Pomodoro timer
let pomodoroState = {
    label: '',
    tasks: [],
    totalTime: 25 * 60, // Default 25 minutes
    timeLeft: 25 * 60,
    isActive: false,
    timer: null
};

async function savePomodoroState() {
    const user = auth.currentUser;
    if (user) {
        const stateToSave = {
            label: pomodoroState.label,
            tasks: pomodoroState.tasks,
            totalTime: pomodoroState.totalTime,
            timeLeft: pomodoroState.timeLeft,
            isActive: pomodoroState.isActive,
            lastUpdated: serverTimestamp()
        };
        try {
            await set(ref(db, `users/${user.uid}/pomodoroState`), stateToSave);
        } catch (error) {
            console.error('Failed to save Pomodoro state:', error);
        }
    }
}

async function loadPomodoroState() {
    const user = auth.currentUser;
    if (user) {
        try {
            const snapshot = await get(ref(db, `users/${user.uid}/pomodoroState`));
            if (snapshot.exists()) {
                const savedState = snapshot.val();
                pomodoroState = { ...pomodoroState, ...savedState };
            }
        } catch (error) {
            console.error('Failed to load Pomodoro state:', error);
        }
    }
}

function updateTimerDisplay() {
    const minutes = Math.floor(pomodoroState.timeLeft / 60);
    const seconds = pomodoroState.timeLeft % 60;
    document.getElementById('timer-display').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function updateTaskList() {
    const taskList = document.getElementById('task-list');
    taskList.innerHTML = '';
    pomodoroState.tasks.forEach((task, index) => {
        if (!task.completed) {
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between p-2 mb-2 neumorphic';
            li.innerHTML = `
                <span>${task.text}</span>
                <button onclick="completeTask(${index})" class="neumorphic-button px-2 py-1">Complete</button>
            `;
            taskList.appendChild(li);
        }
    });
}

window.addTask = function() {
    const taskInput = document.getElementById('task-input');
    const taskText = taskInput.value.trim();
    if (taskText) {
        pomodoroState.tasks.push({ text: taskText, completed: false });
        taskInput.value = '';
        updateTaskList();
        savePomodoroState();
    }
}

window.completeTask = function(index) {
    pomodoroState.tasks[index].completed = true;
    updateTaskList();
    savePomodoroState();
}

window.startPomodoro = function() {
    if (!pomodoroState.isActive) {
        pomodoroState.isActive = true;
        document.getElementById('start-button').textContent = 'Pause';
        pomodoroState.timer = setInterval(() => {
            pomodoroState.timeLeft--;
            updateTimerDisplay();
            if (pomodoroState.timeLeft % 10 === 0) { // Save state every 10 seconds
                savePomodoroState();
            }
            if (pomodoroState.timeLeft === 0) {
                clearInterval(pomodoroState.timer);
                pomodoroState.isActive = false;
                document.getElementById('start-button').textContent = 'Start';
                alert('Pomodoro completed!');
                window.resetPomodoro();
            }
        }, 1000);
    } else {
        clearInterval(pomodoroState.timer);
        pomodoroState.isActive = false;
        document.getElementById('start-button').textContent = 'Start';
    }
    savePomodoroState();
}

window.resetPomodoro = function() {
    clearInterval(pomodoroState.timer);
    pomodoroState.timeLeft = pomodoroState.totalTime;
    pomodoroState.isActive = false;
    document.getElementById('start-button').textContent = 'Start';
    updateTimerDisplay();
    savePomodoroState();
}

window.updatePomodoroSettings = function() {
    pomodoroState.label = document.getElementById('pomodoro-label').value;
    const minutes = parseInt(document.getElementById('pomodoro-minutes').value);
    pomodoroState.totalTime = minutes * 60;
    pomodoroState.timeLeft = pomodoroState.totalTime;
    updateTimerDisplay();
    savePomodoroState();
}

window.showPomodoro = async function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <div id="pomodoro-container" class="neumorphic p-4">
            <h2 class="text-2xl font-bold mb-4">Customizable Pomodoro Timer</h2>
            <div class="mb-4">
                <input type="text" id="pomodoro-label" class="neumorphic-inset w-full p-2 mb-2" placeholder="Label (e.g., Study Session)" value="${pomodoroState.label}">
                <div class="flex space-x-2 mb-2">
                    <input type="number" id="pomodoro-minutes" class="neumorphic-inset w-1/3 p-2" min="1" max="120" value="${Math.floor(pomodoroState.totalTime / 60)}">
                    <button onclick="window.updatePomodoroSettings()" class="neumorphic-button w-2/3 p-2">Update Settings</button>
                </div>
            </div>
            <div id="timer-display" class="text-6xl font-bold text-center mb-4">25:00</div>
            <div class="flex space-x-2 mb-4">
                <button id="start-button" onclick="window.startPomodoro()" class="neumorphic-button w-1/2 p-2">Start</button>
                <button onclick="window.resetPomodoro()" class="neumorphic-button w-1/2 p-2">Reset</button>
            </div>
            <div class="mb-4">
                <h3 class="text-xl font-bold mb-2">Tasks</h3>
                <div class="flex space-x-2 mb-2">
                    <input type="text" id="task-input" class="neumorphic-inset w-3/4 p-2" placeholder="Enter a task">
                    <button onclick="window.addTask()" class="neumorphic-button w-1/4 p-2">Add Task</button>
                </div>
                <ul id="task-list" class="space-y-2"></ul>
            </div>
        </div>
    `;
    await loadPomodoroState();
    updateTimerDisplay();
    updateTaskList();
}


// Show microblog
window.showMicroblog = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">My Microblog</h2>
        <div class="neumorphic p-4 mb-4">
            <textarea id="post-content" class="w-full p-2 mb-2 neumorphic-inset" rows="3" placeholder="What's on your mind?"></textarea>
            <div class="flex justify-between items-center">
                <div id="mood-selector" class="space-x-2">
                    <button class="mood-emoji" data-mood="happy">üòä</button>
                    <button class="mood-emoji" data-mood="sad">üò¢</button>
                    <button class="mood-emoji" data-mood="excited">üòÉ</button>
                    <button class="mood-emoji" data-mood="tired">üò¥</button>
                    <button class="mood-emoji" data-mood="neutral">üòê</button>
                </div>
                <button onclick="createPost()" class="neumorphic-button p-2">Post</button>
            </div>
        </div>
        <div id="posts-list"></div>
    `;
    loadPosts();
    initMoodSelector();
}

// Initialize mood selector
function initMoodSelector() {
    const moodButtons = document.querySelectorAll('.mood-emoji');
    moodButtons.forEach(button => {
        button.addEventListener('click', function() {
            moodButtons.forEach(btn => btn.classList.remove('selected'));
            this.classList.add('selected');
        });
    });
}

// Create a new post
window.createPost = async function() {
    const content = document.getElementById('post-content').value;
    const selectedMood = document.querySelector('.mood-emoji.selected');
    const mood = selectedMood ? selectedMood.getAttribute('data-mood') : null;

    if (!content.trim()) {
        alert('Please enter some content for your post.');
        return;
    }

    const user = auth.currentUser;
    try {
        const postRef = push(ref(db, `posts/${user.uid}`));
        await set(postRef, {
            content: content,
            mood: mood,
            timestamp: serverTimestamp()
        });
        document.getElementById('post-content').value = '';
        document.querySelectorAll('.mood-emoji').forEach(btn => btn.classList.remove('selected'));
        loadPosts();
    } catch (error) {
        console.error('Failed to create post:', error);
    }
}

// Load posts
async function loadPosts() {
    const user = auth.currentUser;
    const postsRef = ref(db, `posts/${user.uid}`);
    const postsList = document.getElementById('posts-list');
    postsList.innerHTML = '';

    onValue(postsRef, (snapshot) => {
        postsList.innerHTML = '';
        const posts = [];
        snapshot.forEach((childSnapshot) => {
            posts.push({
                id: childSnapshot.key,
                ...childSnapshot.val()
            });
        });

        // Sort posts by timestamp in descending order
        posts.sort((a, b) => b.timestamp - a.timestamp);

        posts.forEach((post) => {
            const postElement = createPostElement(post);
            postsList.appendChild(postElement);
        });
    });
}

// Create a post element
function createPostElement(post) {
    const postElement = document.createElement('div');
    postElement.className = 'neumorphic p-4 mb-4';
    
    const moodEmoji = post.mood ? `<span class="text-2xl mr-2">${getMoodEmoji(post.mood)}</span>` : '';
    const formattedDate = new Date(post.timestamp).toLocaleString();

    postElement.innerHTML = `
        <div class="flex justify-between items-start mb-2">
            ${moodEmoji}
            <span class="text-sm text-gray-500">${formattedDate}</span>
        </div>
        <p class="text-gray-800">${post.content}</p>
    `;

    return postElement;
}

// Get mood emoji
function getMoodEmoji(mood) {
    const emojis = {
        happy: 'üòä',
        sad: 'üò¢',
        excited: 'üòÉ',
        tired: 'üò¥',
        neutral: 'üòê'
    };
    return emojis[mood] || '';
}

// Show student microblogs (for teachers)
window.showStudentMicroblogs = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Student Microblogs</h2>
        <select id="student-microblog-select" class="neumorphic-inset w-full p-2 mb-4"></select>
        <div id="student-posts-list"></div>
    `;
    loadStudentsForMicroblog();
}

// Load students for microblog selection
async function loadStudentsForMicroblog() {
    try {
        const user = auth.currentUser;
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const usersRef = ref(db, 'users');
        const snapshot = await get(usersRef);
        const studentSelect = document.getElementById('student-microblog-select');
        studentSelect.innerHTML = '<option value="">Select a student</option>';

        snapshot.forEach((childSnapshot) => {
            const studentData = childSnapshot.val();
            if (studentData.role === 'student' && studentData.schoolCode === schoolCode) {
                const option = document.createElement('option');
                option.value = childSnapshot.key;
                option.textContent = studentData.fullName;
                studentSelect.appendChild(option);
            }
        });

        studentSelect.addEventListener('change', function() {
            if (this.value) {
                loadStudentPosts(this.value);
            }
        });
    } catch (error) {
        console.error('Failed to load students for microblog:', error);
    }
}

// Load student posts
function loadStudentPosts(studentId) {
    const postsRef = ref(db, `posts/${studentId}`);
    const postsList = document.getElementById('student-posts-list');
    postsList.innerHTML = '';

    onValue(postsRef, (snapshot) => {
        postsList.innerHTML = '';
        const posts = [];
        snapshot.forEach((childSnapshot) => {
            posts.push({
                id: childSnapshot.key,
                ...childSnapshot.val()
            });
        });

        // Sort posts by timestamp in descending order
        posts.sort((a, b) => b.timestamp - a.timestamp);

        posts.forEach((post) => {
            const postElement = createPostElement(post);
            postsList.appendChild(postElement);
        });
    });
}

// Relatedness Mode Functions

// Show team leaderboard
window.showTeamLeaderboard = async function() {
    const user = auth.currentUser;
    const userRef = ref(db, `users/${user.uid}`);
    const userSnapshot = await get(userRef);
    const userData = userSnapshot.val();
    const schoolCode = userData.schoolCode;

    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Team Leaderboard</h2>
        <ul id="team-leaderboard-list" class="space-y-2"></ul>
    `;

    setupTeamPointsListener(schoolCode);
}

// Load team leaderboard
async function loadTeamLeaderboard() {
    try {
        const user = auth.currentUser;
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const teamsRef = ref(db, `schools/${schoolCode}/teams`);
        const snapshot = await get(teamsRef);
        const leaderboardList = document.getElementById('team-leaderboard-list');
        leaderboardList.innerHTML = ''; // Clear the list first

        const leaderboardData = [];
        snapshot.forEach((childSnapshot) => {
            const teamData = childSnapshot.val();
            leaderboardData.push({
                name: childSnapshot.key,
                points: teamData.points || 0
            });
        });

        // Sort leaderboard by points in descending order
        leaderboardData.sort((a, b) => b.points - a.points);

        leaderboardData.forEach((entry, index) => {
            const listItem = document.createElement('div');
            listItem.className = 'neumorphic p-4 mb-4';
            listItem.innerHTML = `
                <span class="font-bold">#${index + 1}</span>
                <span class="ml-4">${entry.name}</span>
                <span class="float-right">${entry.points} points</span>
            `;
            leaderboardList.appendChild(listItem);
        });
    } catch (error) {
        console.error('Failed to load team leaderboard:', error);
    }
}

window.showResetTeamGamification = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Reset Team Gamification</h2>
        <div class="neumorphic p-6">
            <p class="mb-4">Warning: This action will reset all team points and the team leaderboard for your school. This action cannot be undone.</p>
            <button onclick="confirmResetTeamGamification()" class="neumorphic-button py-2 px-4 text-red-600 font-semibold">Reset All Team Gamification Data</button>
        </div>
    `;
}

window.confirmResetTeamGamification = function() {
    if (confirm("Are you sure you want to reset all team gamification data? This action cannot be undone.")) {
        resetTeamGamificationData();
    }
}

async function resetTeamGamificationData() {
    const user = auth.currentUser;
    try {
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        // Reset team leaderboard
        await set(ref(db, `schools/${schoolCode}/teamLeaderboard`), null);

        // Reset all teams' points
        const teamsRef = ref(db, `schools/${schoolCode}/teams`);
        const teamsSnapshot = await get(teamsRef);
        const updates = {};

        teamsSnapshot.forEach((teamSnapshot) => {
            updates[`${teamSnapshot.key}/points`] = 0;
        });

        await update(teamsRef, updates);

        alert('Team gamification data has been reset successfully.');
    } catch (error) {
        console.error('Failed to reset team gamification data:', error);
        alert('Failed to reset team gamification data. Please try again.');
    }
}

// Show team management (for teachers)
window.showTeamManagement = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Team Management</h2>
        <div class="neumorphic p-4 mb-4">
            <h3 class="text-xl font-bold mb-2">Create Team</h3>
            <input type="text" id="team-name" placeholder="Team Name" class="w-full p-2 mb-2 neumorphic-inset">
            <button onclick="createTeam()" class="neumorphic-button p-2">Create Team</button>
        </div>
        <div class="neumorphic p-4 mb-4">
            <h3 class="text-xl font-bold mb-2">Assign Student to Team</h3>
            <select id="student-select" class="w-full p-2 mb-2 neumorphic-inset"></select>
            <select id="team-select" class="w-full p-2 mb-2 neumorphic-inset"></select>
            <button onclick="assignStudentToTeam()" class="neumorphic-button p-2">Assign Student</button>
        </div>
        <div class="neumorphic p-4 mb-4">
            <h3 class="text-xl font-bold mb-2">Award Points to Team</h3>
            <select id="team-points-select" class="w-full p-2 mb-2 neumorphic-inset"></select>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="awardTeamPoints(10)" class="neumorphic-button p-2">+10 Points</button>
                <button onclick="awardTeamPoints(-10)" class="neumorphic-button p-2">-10 Points</button>
                <button onclick="awardTeamPoints(20)" class="neumorphic-button p-2">+20 Points</button>
                <button onclick="awardTeamPoints(-20)" class="neumorphic-button p-2">-20 Points</button>
                <button onclick="awardTeamPoints(50)" class="neumorphic-button p-2">+50 Points</button>
                <button onclick="awardTeamPoints(-50)" class="neumorphic-button p-2">-50 Points</button>
                <button onclick="awardTeamPoints(100)" class="neumorphic-button p-2">+100 Points</button>
                <button onclick="awardTeamPoints(-100)" class="neumorphic-button p-2">-100 Points</button>
            </div>
        </div>
        <div class="neumorphic p-4 mb-4">
            <h3 class="text-xl font-bold mb-2">Delete Team</h3>
            <select id="delete-team-select" class="w-full p-2 mb-2 neumorphic-inset"></select>
            <button onclick="deleteTeam()" class="neumorphic-button p-2 bg-red-500 text-white">Delete Team</button>
        </div>
        <div id="teams-list"></div>
    `;
    loadTeamsAndStudents();
    loadTeamsForPointsAwarding();
    loadTeamsForDeletion();
}

async function loadTeamsForPointsAwarding() {
    const teamPointsSelect = document.getElementById('team-points-select');
    teamPointsSelect.innerHTML = '<option value="">Select a team</option>';
    
    try {
        const user = auth.currentUser;
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const teamsRef = ref(db, `schools/${schoolCode}/teams`);
        const teamsSnapshot = await get(teamsRef);
        
        if (teamsSnapshot.exists()) {
            teamsSnapshot.forEach((childSnapshot) => {
                const teamName = childSnapshot.key;
                const option = document.createElement('option');
                option.value = teamName;
                option.textContent = teamName;
                teamPointsSelect.appendChild(option);
            });
        } else {
            console.log('No teams found');
        }
    } catch (error) {
        console.error('Error loading teams for points awarding:', error);
    }
}


// Create a new team
window.createTeam = async function() {
    const teamName = document.getElementById('team-name').value;
    if (!teamName.trim()) {
        alert('Please enter a team name.');
        return;
    }

    const user = auth.currentUser;
    try {
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const teamRef = ref(db, `schools/${schoolCode}/teams/${teamName}`);
        await set(teamRef, { points: 0, members: [] });
        alert('Team created successfully!');
        loadTeamsAndStudents();
    } catch (error) {
        console.error('Failed to create team:', error);
    }
}

// Assign student to team
window.assignStudentToTeam = async function() {
    const studentId = document.getElementById('student-select').value;
    const teamName = document.getElementById('team-select').value;
    if (!studentId || !teamName) {
        alert('Please select both a student and a team.');
        return;
    }

    const user = auth.currentUser;
    try {
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const teamRef = ref(db, `schools/${schoolCode}/teams/${teamName}/members`);
        const teamSnapshot = await get(teamRef);
        const teamMembers = teamSnapshot.val() || [];
        if (!teamMembers.includes(studentId)) {
            teamMembers.push(studentId);
            await set(teamRef, teamMembers);
            await update(ref(db, `users/${studentId}`), { team: teamName });
            alert('Student assigned to team successfully!');
            loadTeamsAndStudents();
        } else {
            alert('Student is already in this team.');
        }
    } catch (error) {
        console.error('Failed to assign student to team:', error);
    }
}

async function loadTeamsForDeletion() {
    const deleteTeamSelect = document.getElementById('delete-team-select');
    deleteTeamSelect.innerHTML = '<option value="">Select a team to delete</option>';
    
    try {
        const user = auth.currentUser;
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const teamsRef = ref(db, `schools/${schoolCode}/teams`);
        const teamsSnapshot = await get(teamsRef);
        
        if (teamsSnapshot.exists()) {
            teamsSnapshot.forEach((childSnapshot) => {
                const teamName = childSnapshot.key;
                const option = document.createElement('option');
                option.value = teamName;
                option.textContent = teamName;
                deleteTeamSelect.appendChild(option);
            });
        } else {
            console.log('No teams found');
        }
    } catch (error) {
        console.error('Error loading teams for deletion:', error);
    }
}

// Add this new function to delete a team
window.deleteTeam = async function() {
    const teamToDelete = document.getElementById('delete-team-select').value;
    if (!teamToDelete) {
        alert('Please select a team to delete.');
        return;
    }

    if (confirm(`Are you sure you want to delete the team "${teamToDelete}"? This action cannot be undone.`)) {
        const user = auth.currentUser;
        try {
            const userRef = ref(db, `users/${user.uid}`);
            const userSnapshot = await get(userRef);
            const userData = userSnapshot.val();
            const schoolCode = userData.schoolCode;

            // Delete the team
            await remove(ref(db, `schools/${schoolCode}/teams/${teamToDelete}`));

            // Remove team association from students
            const usersRef = ref(db, 'users');
            const usersSnapshot = await get(usersRef);
            const updates = {};

            usersSnapshot.forEach((childSnapshot) => {
                const studentData = childSnapshot.val();
                if (studentData.role === 'student' && studentData.schoolCode === schoolCode && studentData.team === teamToDelete) {
                    updates[`${childSnapshot.key}/team`] = null;
                }
            });

            await update(usersRef, updates);

            alert(`Team "${teamToDelete}" has been deleted successfully.`);
            loadTeamsAndStudents();
            loadTeamsForPointsAwarding();
            loadTeamsForDeletion();
        } catch (error) {
            console.error('Failed to delete team:', error);
            alert('Failed to delete team. Please try again.');
        }
    }
}
// Load teams and students
async function loadTeamsAndStudents() {
    const user = auth.currentUser;
    try {
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const teamsRef = ref(db, `schools/${schoolCode}/teams`);
        const teamsSnapshot = await get(teamsRef);
        const teamSelect = document.getElementById('team-select');
        teamSelect.innerHTML = '<option value="">Select a team</option>';
        teamsSnapshot.forEach((childSnapshot) => {
            const option = document.createElement('option');
            option.value = childSnapshot.key;
            option.textContent = childSnapshot.key;
            teamSelect.appendChild(option);
        });

        const usersRef = ref(db, 'users');
        const usersSnapshot = await get(usersRef);
        const studentSelect = document.getElementById('student-select');
        studentSelect.innerHTML = '<option value="">Select a student</option>';
        usersSnapshot.forEach((childSnapshot) => {
            const studentData = childSnapshot.val();
            if (studentData.role === 'student' && studentData.schoolCode === schoolCode) {
                const option = document.createElement('option');
                option.value = childSnapshot.key;
                option.textContent = studentData.fullName;
                studentSelect.appendChild(option);
            }
        });

        const teamsList = document.getElementById('teams-list');
        teamsList.innerHTML = '';
        teamsSnapshot.forEach((childSnapshot) => {
            const teamData = childSnapshot.val();
            const teamElement = document.createElement('div');
            teamElement.className = 'neumorphic p-4 mb-4';
            teamElement.innerHTML = `
                <h3 class="text-xl font-bold mb-2">${childSnapshot.key}</h3>
                <p>Points: ${teamData.points || 0}</p>
                <h4 class="font-bold mt-2">Members:</h4>
                <ul id="team-${childSnapshot.key}-members" class="list-disc list-inside"></ul>
            `;
            teamsList.appendChild(teamElement);

            const membersListElement = teamElement.querySelector(`#team-${childSnapshot.key}-members`);
            if (teamData.members && teamData.members.length > 0) {
                teamData.members.forEach(async (memberId) => {
                    const memberRef = ref(db, `users/${memberId}`);
                    const memberSnapshot = await get(memberRef);
                    const memberData = memberSnapshot.val();
                    const memberListItem = document.createElement('li');
                    memberListItem.textContent = memberData.fullName;
                    membersListElement.appendChild(memberListItem);
                });
            } else {
                membersListElement.innerHTML = '<li>No members yet</li>';
            }
        });
    } catch (error) {
        console.error('Failed to load teams and students:', error);
    }
}

// Show team info (for students)
window.showTeamInfo = async function() {
    const user = auth.currentUser;
    try {
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        
        if (!userData.team) {
            alert('You are not assigned to a team yet.');
            return;
        }

        const schoolCode = userData.schoolCode;
        const teamRef = ref(db, `schools/${schoolCode}/teams/${userData.team}`);
        const teamSnapshot = await get(teamRef);
        const teamData = teamSnapshot.val();

        const mainContent = document.getElementById('main-content');
        mainContent.innerHTML = `
            <h2 class="text-2xl font-bold mb-4">My Team: ${userData.team}</h2>
            <div class="neumorphic p-4 mb-4">
                <p>Team Points: ${teamData.points || 0}</p>
                <h3 class="text-xl font-bold mt-4 mb-2">Team Members:</h3>
                <ul id="team-members-list" class="list-disc list-inside"></ul>
            </div>
            <div class="neumorphic p-4 mb-4">
                <h3 class="text-xl font-bold mb-2">Team Chat</h3>
                <div id="team-chat" class="h-64 overflow-y-auto mb-4 p-2 neumorphic-inset"></div>
                <input type="text" id="chat-message" placeholder="Type your message" class="w-full p-2 mb-2 neumorphic-inset">
                <button onclick="sendTeamMessage()" class="neumorphic-button p-2">Send Message</button>
            </div>
        `;

        const teamMembersList = document.getElementById('team-members-list');
        if (teamData.members && teamData.members.length > 0) {
            teamData.members.forEach(async (memberId) => {
                const memberRef = ref(db, `users/${memberId}`);
                const memberSnapshot = await get(memberRef);
                const memberData = memberSnapshot.val();
                const memberListItem = document.createElement('li');
                memberListItem.textContent = memberData.fullName;
                teamMembersList.appendChild(memberListItem);
            });
        } else {
            teamMembersList.innerHTML = '<li>No other members yet</li>';
        }

        loadTeamChat(schoolCode, userData.team);
    } catch (error) {
        console.error('Failed to load team info:', error);
    }
}

// Load team chat
function loadTeamChat(schoolCode, teamName) {
    const chatRef = ref(db, `schools/${schoolCode}/teams/${teamName}/chat`);
    const chatElement = document.getElementById('team-chat');

    onValue(chatRef, (snapshot) => {
        chatElement.innerHTML = '';
        snapshot.forEach((childSnapshot) => {
            const message = childSnapshot.val();
            const messageId = childSnapshot.key;
            const messageElement = document.createElement('div');
            messageElement.className = 'mb-2 p-2 bg-white rounded shadow';
            
            const likesCount = Object.keys(message.likes || {}).length;
            const dislikesCount = Object.keys(message.dislikes || {}).length;
            
            messageElement.innerHTML = `
                <strong>${message.sender}:</strong> ${message.text}
                <small class="text-gray-500 ml-2">${new Date(message.timestamp).toLocaleString()}</small>
                <div class="mt-2">
                    <button onclick="likeMessage('${messageId}')" class="like-btn mr-2">üëç ${likesCount}</button>
                    <button onclick="dislikeMessage('${messageId}')" class="dislike-btn">üëé ${dislikesCount}</button>
                </div>
            `;
            chatElement.appendChild(messageElement);
        });
        chatElement.scrollTop = chatElement.scrollHeight;
    });
}

// Send team message
window.sendTeamMessage = async function() {
    const user = auth.currentUser;
    const messageText = document.getElementById('chat-message').value;
    if (!messageText.trim()) {
        alert('Please enter a message.');
        return;
    }

    try {
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;
        const teamName = userData.team;

        const chatRef = ref(db, `schools/${schoolCode}/teams/${teamName}/chat`);
        const newMessageRef = push(chatRef);
        await set(newMessageRef, {
            sender: userData.fullName,
            senderId: user.uid,
            text: messageText,
            timestamp: serverTimestamp(),
            likes: {},
            dislikes: {}
        });

        document.getElementById('chat-message').value = '';
    } catch (error) {
        console.error('Failed to send team message:', error);
    }
}

async function likeMessage(messageId) {
    const user = auth.currentUser;
    if (!user) return;

    const userRef = ref(db, `users/${user.uid}`);
    const userSnapshot = await get(userRef);
    const userData = userSnapshot.val();
    const schoolCode = userData.schoolCode;
    const teamName = userData.team;

    const messageRef = ref(db, `schools/${schoolCode}/teams/${teamName}/chat/${messageId}`);
    const messageSnapshot = await get(messageRef);
    const messageData = messageSnapshot.val();

    const likes = messageData.likes || {};
    const dislikes = messageData.dislikes || {};

    if (likes[user.uid]) {
        // User already liked, remove the like
        delete likes[user.uid];
    } else {
        // Add like and remove dislike if exists
        likes[user.uid] = true;
        delete dislikes[user.uid];
    }

    await update(messageRef, { likes, dislikes });
}

async function dislikeMessage(messageId) {
    const user = auth.currentUser;
    if (!user) return;

    const userRef = ref(db, `users/${user.uid}`);
    const userSnapshot = await get(userRef);
    const userData = userSnapshot.val();
    const schoolCode = userData.schoolCode;
    const teamName = userData.team;

    const messageRef = ref(db, `schools/${schoolCode}/teams/${teamName}/chat/${messageId}`);
    const messageSnapshot = await get(messageRef);
    const messageData = messageSnapshot.val();

    const likes = messageData.likes || {};
    const dislikes = messageData.dislikes || {};

    if (dislikes[user.uid]) {
        // User already disliked, remove the dislike
        delete dislikes[user.uid];
    } else {
        // Add dislike and remove like if exists
        dislikes[user.uid] = true;
        delete likes[user.uid];
    }

    await update(messageRef, { likes, dislikes });
}


// Utility Functions

// Load user data
async function loadUserData(uid) {
    const userRef = ref(db, `users/${uid}`);
    const snapshot = await get(userRef);
    return snapshot.val();
}

// Apply theme
function applyTheme(theme) {
    document.body.className = `theme-${theme}`;
}

// Authentication state change handler
auth.onAuthStateChanged(async (user) => {
    if (user) {
        const userData = await loadUserData(user.uid);
        if (userData.theme) {
            applyTheme(userData.theme);
        }
        loadDashboard(user);
    } else {
        document.getElementById('auth-container').style.display = 'flex';
        document.getElementById('sidebar').style.display = 'none';
        document.getElementById('main-content').style.display = 'none';
    }
});

// Initialize application
function initApp() {
    document.getElementById('login-button').addEventListener('click', login);
    document.getElementById('register-role').addEventListener('change', toggleGamificationMode);
    
    // Ensure the gamification mode is hidden initially
    toggleGamificationMode();
}

// Call initApp when the DOM is fully loaded
document.addEventListener('DOMContentLoaded', initApp);

// Add ripple effect to buttons
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('neumorphic-button')) {
        const button = e.target;
        const ripple = document.createElement('span');
        const rect = button.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        
        ripple.style.width = ripple.style.height = `${size}px`;
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;
        ripple.classList.add('ripple');
        
        button.appendChild(ripple);
        
        setTimeout(() => {
            ripple.remove();
        }, 600);
    }
});

window.showAvatarCustomization = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Avatar Customization</h2>
        <div id="avatar-customization" class="neumorphic p-6">
            <h3 class="text-xl font-semibold mb-4 text-indigo-600">Customize Your Avatar</h3>
            <img id="avatar-preview" src="https://avataaars.io/?avatarStyle=Circle" alt="Avatar" class="w-32 h-32 rounded-full mx-auto mb-4" />
            <button onclick="randomizeAvatar()" class="neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold mb-4">Randomize Avatar</button>
            <button onclick="saveAvatar()" class="neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold">Save Avatar</button>
        </div>
    `;
    loadAvatar();
}
window.randomizeAvatar = function() {
    const avatarParams = {
        topType: getRandomTopType(),
        accessoriesType: getRandomAccessoriesType(),
        hairColor: getRandomHairColor(),
        facialHairType: getRandomFacialHairType(),
        facialHairColor: getRandomFacialHairColor(),
        clotheType: getRandomClotheType(),
        clotheColor: getRandomClotheColor(),
        eyeType: getRandomEyeType(),
        eyebrowType: getRandomEyebrowType(),
        mouthType: getRandomMouthType(),
        skinColor: getRandomSkinColor(),
    };

    const avatarUrl = `https://avataaars.io/?${new URLSearchParams(avatarParams)}`;
    document.getElementById('avatar-preview').src = avatarUrl;
}

window.saveAvatar = async function() {
    const avatarUrl = document.getElementById('avatar-preview').src;
    const user = auth.currentUser;

    if (user) {
        try {
            await update(ref(db, 'users/' + user.uid), { avatarUrl: avatarUrl });
            alert('Avatar saved successfully!');
        } catch (error) {
            alert('Failed to save avatar: ' + error.message);
        }
    }
}

window.getRandomTopType = function() {
    const topTypes = [
        'NoHair', 'Eyepatch', 'Hat', 'Hijab', 'Turban', 'WinterHat1', 'LongHairStraight',
        'LongHairCurvy', 'ShortHairShortCurly', 'ShortHairShaggyMullet'
    ];
    return topTypes[Math.floor(Math.random() * topTypes.length)];
}

window.getRandomAccessoriesType = function() {
    const accessoriesTypes = ['Blank', 'Kurt', 'Prescription02', 'Round'];
    return accessoriesTypes[Math.floor(Math.random() * accessoriesTypes.length)];
}

window.getRandomHairColor = function() {
    const hairColors = ['Auburn', 'Black', 'Blonde', 'BrownDark', 'Red', 'SilverGray'];
    return hairColors[Math.floor(Math.random() * hairColors.length)];
}

window.getRandomFacialHairType = function() {
    const facialHairTypes = ['Blank', 'BeardLight', 'MoustacheFancy'];
    return facialHairTypes[Math.floor(Math.random() * facialHairTypes.length)];
}

window.getRandomFacialHairColor = function() {
    const facialHairColors = ['Black', 'BrownDark', 'Red'];
    return facialHairColors[Math.floor(Math.random() * facialHairColors.length)];
}

window.getRandomClotheType = function() {
    const clotheTypes = ['BlazerShirt', 'BlazerSweater', 'Hoodie', 'Overall'];
    return clotheTypes[Math.floor(Math.random() * clotheTypes.length)];
}

window.getRandomClotheColor = function() {
    const clotheColors = ['PastelBlue', 'PastelGreen', 'PastelOrange', 'PastelRed'];
    return clotheColors[Math.floor(Math.random() * clotheColors.length)];
}

window.getRandomEyeType = function() {
    const eyeTypes = ['Close', 'Cry', 'Happy', 'Hearts'];
    return eyeTypes[Math.floor(Math.random() * eyeTypes.length)];
}

window.getRandomEyebrowType = function() {
    const eyebrowTypes = ['Angry', 'Default', 'FlatNatural', 'RaisedExcited'];
    return eyebrowTypes[Math.floor(Math.random() * eyebrowTypes.length)];
}

window.getRandomMouthType = function() {
    const mouthTypes = ['Smile', 'Disbelief', 'Serious', 'ScreamOpen'];
    return mouthTypes[Math.floor(Math.random() * mouthTypes.length)];
}

window.getRandomSkinColor = function() {
    const skinColors = ['Light', 'Brown', 'Black', 'Pale'];
    return skinColors[Math.floor(Math.random() * skinColors.length)];
}

window.loadAvatar = async function() {
    const user = auth.currentUser;
    if (user) {
        const userSnapshot = await get(ref(db, 'users/' + user.uid));
        if (userSnapshot.exists()) {
            const userData = userSnapshot.val();
            const avatarUrl = userData.avatarUrl || 'https://avataaars.io/?avatarStyle=Circle';
            document.getElementById('avatar-preview').src = avatarUrl;
        }
    }
}
window.awardTeamPoints = async function(points) {
    const teamSelect = document.getElementById('team-points-select');
    const selectedTeamName = teamSelect.value;

    if (!selectedTeamName) {
        alert('Please select a team first.');
        return;
    }

    try {
        const user = auth.currentUser;
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const teamRef = ref(db, `schools/${schoolCode}/teams/${selectedTeamName}`);
        const teamSnapshot = await get(teamRef);

        if (teamSnapshot.exists()) {
            const teamData = teamSnapshot.val();
            const newPoints = (teamData.points || 0) + points;

            await update(teamRef, { points: newPoints });
            alert(`Successfully awarded ${points} points to ${selectedTeamName}!`);
            // The listener will automatically update the leaderboard
        } else {
            alert('Selected team not found.');
        }
    } catch (error) {
        console.error('Error awarding team points:', error);
        alert('Failed to award points. Please try again.');
    }
}

async function populateTeamSelect() {
    const teamSelect = document.getElementById('team-select');
    teamSelect.innerHTML = '<option value="">Select a team</option>';

    try {
        const teamsSnapshot = await get(ref(db, 'teams'));
        if (teamsSnapshot.exists()) {
            const teamsData = teamsSnapshot.val();
            for (const teamId in teamsData) {
                const team = teamsData[teamId];
                const option = document.createElement('option');
                option.value = teamId;
                option.textContent = team.name;
                teamSelect.appendChild(option);
            }
        }
    } catch (error) {
        console.error('Error populating team select:', error);
    }
}

function updateTeamLeaderboard(teamsData) {
    const leaderboardList = document.getElementById('team-leaderboard-list');
    if (!leaderboardList) return; // Exit if the leaderboard element doesn't exist

    leaderboardList.innerHTML = '';
    
    const sortedTeams = Object.entries(teamsData)
        .sort(([, a], [, b]) => (b.points || 0) - (a.points || 0));

    sortedTeams.forEach(([teamName, teamData], index) => {
        const listItem = document.createElement('li');
        listItem.className = 'mb-2 p-2 bg-white rounded shadow';
        listItem.innerHTML = `
            <span class="font-bold">${index + 1}.</span>
            <span class="ml-2">${teamName}:</span>
            <span class="ml-2 font-semibold">${teamData.points || 0} points</span>
        `;
        leaderboardList.appendChild(listItem);
    });
}

function initRelatednessMode() {
    showTeamLeaderboard();
    if (currentUserRole === 'teacher') {
        showTeamManagement();
    } else {
        showTeamInfo();
    }
}

function setupTeamPointsListener(schoolCode) {
    const teamsRef = ref(db, `schools/${schoolCode}/teams`);
    onValue(teamsRef, (snapshot) => {
        if (snapshot.exists()) {
            updateTeamLeaderboard(snapshot.val());
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded');
    const roleSelect = document.getElementById('register-role');
    const gamificationModeSelect = document.getElementById('register-gamification-mode');
    
    if (roleSelect && gamificationModeSelect) {
        console.log('Required elements found');
        roleSelect.addEventListener('change', toggleGamificationMode);
        // Initially hide the gamification mode select
        gamificationModeSelect.classList.add('hidden');
    } else {
        console.error('Required elements not found');
        if (!roleSelect) console.error('register-role element not found');
        if (!gamificationModeSelect) console.error('register-gamification-mode element not found');
    }
});

function toggleGamificationMode() {
    const roleSelect = document.getElementById('register-role');
    const gamificationModeSelect = document.getElementById('register-gamification-mode');
    
    if (roleSelect && gamificationModeSelect) {
        if (roleSelect.value === 'teacher') {
            gamificationModeSelect.classList.remove('hidden');
        } else {
            gamificationModeSelect.classList.add('hidden');
            gamificationModeSelect.value = ''; // Reset the selection
        }
    } else {
        console.error('Elements not found in toggleGamificationMode');
    }
}

window.likeMessage = likeMessage;
window.dislikeMessage = dislikeMessage;

document.addEventListener('DOMContentLoaded', function() {
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebar = document.getElementById('sidebar');

    sidebarToggle.addEventListener('click', function() {
        sidebar.classList.toggle('active');
    });

    // Close sidebar when clicking outside of it
    document.addEventListener('click', function(event) {
        const isClickInsideSidebar = sidebar.contains(event.target);
        const isClickOnToggle = sidebarToggle.contains(event.target);

        if (!isClickInsideSidebar && !isClickOnToggle && sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
        }
    });
});

</script>
</body>
</html>
