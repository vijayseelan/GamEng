<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GamEng!</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General Styles */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

:root {
    --bg-color: linear-gradient(135deg, #FFA500, #FFFFFF, #4169E1);
    --text-color: #1a202c;
    --card-bg: rgba(255, 255, 255, 0.8);
    --card-text: #1a202c;
    --sidebar-bg: #4169E1;
    --sidebar-text: #FFFFFF;
    --primary-color: #4169E1;
    --secondary-color: #FFA500;
    --accent-color: #FF6347;
}

body {
    font-family: 'Poppins', sans-serif;
    background: var(--bg-color);
    color: var(--text-color);
    min-height: 100vh;
}

/* Neumorphic Styles */
.neumorphic {
    background: var(--card-bg);
    border-radius: 15px;
    box-shadow: 8px 8px 15px rgba(0, 0, 0, 0.1), -8px -8px 15px rgba(255, 255, 255, 0.5);
    transition: all 0.3s ease;
}

.neumorphic:hover {
    transform: translateY(-5px);
    box-shadow: 12px 12px 20px rgba(0, 0, 0, 0.15), -12px -12px 20px rgba(255, 255, 255, 0.6);
}

.neumorphic-inset {
    background: var(--card-bg);
    box-shadow: inset 5px 5px 10px rgba(0, 0, 0, 0.1), inset -5px -5px 10px rgba(255, 255, 255, 0.5);
    border-radius: 10px;
    border: none;
    outline: none;
    transition: all 0.3s ease;
}

.neumorphic-inset:focus {
    box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.1), inset -3px -3px 6px rgba(255, 255, 255, 0.5);
}

/* Bubbly Button */
.neumorphic-button, button {
    background: var(--primary-color);
    color: white !important;
    border: none;
    border-radius: 10px;
    padding: 12px 20px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
}

.neumorphic-button:hover, button:hover {
        background: var(--secondary-color);
        color: var(--text-color) !important;
        transform: translateY(-3px);
        box-shadow: 6px 6px 12px rgba(0, 0, 0, 0.15);
    }

    .neumorphic-button *, button * {
        color: white !important;
    }

    .badge-buttons button {
        background: var(--secondary-color);
        color: var(--text-color) !important;
    }

    .badge-buttons button:hover {
        background: var(--accent-color);
        color: white !important;
    }

    #sidebar ul li a {
        color: white !important;
    }

    #sidebar ul li a:hover, #sidebar ul li a.active {
        color: var(--text-color) !important;
    }

    .text-indigo-600 {
        color: var(--primary-color);
    }

    .neumorphic-button.text-indigo-600,
    button.text-indigo-600,
    .neumorphic-button .text-indigo-600,
    button .text-indigo-600 {
        color: white !important;
    }

    button[onclick="logout()"] {
        color: white !important;
    }

    button[onclick="logout()"]:hover {
        color: var(--text-color) !important;
    }

    /* Progress Bar */
    .progress-bar {
        background: var(--card-bg);
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        height: 20px;
        margin: 10px 0;
    }

    .progress {
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        box-shadow: 0 0 10px var(--primary-color);
        border-radius: 10px;
        transition: width 0.5s ease-in-out;
        height: 100%;
    }

    /* Sidebar */
    #sidebar {
        background: var(--sidebar-bg);
        border-right: none;
        color: var(--sidebar-text);
        padding: 20px;
        border-radius: 0 20px 20px 0;
        box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
    }

    #sidebar h2 {
        font-size: 24px;
        margin-bottom: 20px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    #sidebar ul li {
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }

    #sidebar ul li:hover {
        transform: translateX(5px);
    }

    /* Main Content */
    #main-content {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 20px;
        margin: 20px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

    /* Auth Container Styles */
    #auth-container {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
    }

    #auth-container .neumorphic {
        background: var(--card-bg);
        border-radius: 20px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    #app-name {
        color: var(--primary-color);
        font-size: 3rem;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
        animation: float 3s ease-in-out infinite;
    }

    #auth-title {
        color: var(--secondary-color);
        font-size: 1.8rem;
        margin-bottom: 2rem;
    }

    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }

    /* Input fields in auth container */
    #auth-container input {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 10px;
        border: 2px solid var(--primary-color);
        background: var(--card-bg);
        color: var(--text-color);
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
    }

    #auth-container input:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 10px rgba(65, 105, 225, 0.3);
    }

    /* Buttons in auth container */
    #auth-container button {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        border-radius: 10px;
        background: var(--primary-color);
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    #auth-container button:hover {
        background: var(--secondary-color);
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    /* Links in auth container */
    #auth-container a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    #auth-container a:hover {
        color: var(--secondary-color);
        text-decoration: underline;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 10px;
    }

    ::-webkit-scrollbar-track {
        background: var(--card-bg);
        border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--secondary-color);
    }

    #register-gamification-mode {
        background-color: var(--card-bg);
        color: var(--text-color);
        border: 2px solid var(--primary-color);
        border-radius: 10px;
        padding: 10px;
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
        display: block !important;
    }

    #register-gamification-mode.hidden {
        display: none !important;
    }

    #register-gamification-mode:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 10px rgba(65, 105, 225, 0.3);
    }

    #register-gamification-mode option {
        background-color: var(--card-bg);
        color: var(--text-color);
    }

    /* Additional styles for specific elements */
    #app-title {
        color: var(--sidebar-text);
        font-size: 28px;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .badge-buttons button {
        font-size: 14px;
        padding: 8px 16px;
        margin: 5px;
        background: var(--secondary-color);
        color: var(--text-color);
    }

    .badge-buttons button:hover {
        background: var(--accent-color);
        color: var(--sidebar-text);
        transform: rotate(5deg) scale(1.1);
    }

    #avatar {
        border: 4px solid var(--sidebar-text);
        border-radius: 50%;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    #avatar:hover {
        transform: scale(1.1) rotate(5deg);
    }

    .message-container {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .message-container:hover {
        transform: translateY(-5px);
        box-shadow: 8px 8px 20px rgba(0, 0, 0, 0.15);
    }

    #lessons-list .neumorphic, #lessons-management-list .neumorphic {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    #lessons-list img, #lessons-management-list img {
        border-radius: 10px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }

    #lessons-list img:hover, #lessons-management-list img:hover {
        transform: scale(1.05);
    }

    /* Form inputs */
    input[type="text"], input[type="email"], input[type="password"], select, textarea {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 10px;
        border: 2px solid var(--primary-color);
        background: var(--card-bg);
        color: var(--text-color);
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
    }

    input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, select:focus, textarea:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 10px rgba(255, 165, 0, 0.3);
    }

    /* Lesson card styles */
    .lesson-card {
        background: var(--card-bg);
        border-radius: 15px;
        transition: all 0.3s ease;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .lesson-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .lesson-card-header {
        padding: 1.5rem;
        cursor: pointer;
        font-weight: 600;
        color: var(--primary-color);
    }

    .lesson-card-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }

    .lesson-card-content.expanded {
        max-height: 1000px;
        transition: max-height 0.5s ease-in;
    }

    .lesson-card-body {
        padding: 0 1.5rem 1.5rem;
    }

    .lesson-card-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
        transition: all 0.3s ease;
    }

    .lesson-card-image:hover {
        transform: scale(1.05);
    }

    /* Animations */
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }

    .float-animation {
        animation: float 3s ease-in-out infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .pulse-animation {
        animation: pulse 2s ease-in-out infinite;
    }

    /* Apply animations */
    .neumorphic {
        animation: float 3s ease-in-out infinite;
    }

    .neumorphic-button, button {
        animation: pulse 2s ease-in-out infinite;
    }

    /* Timer styles */
    #timer-display {
        font-size: 48px;
        font-weight: bold;
        color: var(--primary-color);
        text-align: center;
        margin: 20px 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Mood emoji styles */
    .mood-emoji {
        font-size: 24px;
        margin: 0 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .mood-emoji:hover, .mood-emoji.selected {
        transform: scale(1.2);
    }

    /* Post card styles */
    .post-card {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .post-card:hover {
        transform: translateY(-5px);
        box-shadow: 8px 8px 20px rgba(0, 0, 0, 0.15);
    }

    /* Leaderboard styles */
    #individual-leaderboard-list li, #team-leaderboard-list li {
        background: var(--primary-color);
        color: var(--sidebar-text);
        padding: 10px 15px;
        margin-bottom: 10px;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    #individual-leaderboard-list li:hover, #team-leaderboard-list li:hover {
        transform: scale(1.05);
        background: var(--secondary-color);
    }

    /* Theme selection styles */
    .theme-button {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .theme-button:hover {
        transform: scale(1.1);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        #sidebar {
            border-radius: 0 0 20px 20px;
        }

        .neumorphic, .neumorphic-button, button {
            font-size: 14px;
        }
    }

    /* Theme styles */
    .theme-default {
        --bg-color: linear-gradient(135deg, #FFA500, #FFFFFF, #4169E1);
        --text-color: #1a202c;
        --card-bg: rgba(255, 255, 255, 0.8);
        --card-text: #1a202c;
        --sidebar-bg: #4169E1;
        --sidebar-text: #FFFFFF;
    }

    .theme-dark {
        --bg-color: #1a202c;
        --text-color: #e2e8f0;
        --card-bg: #2d3748;
        --card-text: #e2e8f0;
        --sidebar-bg: #2d3748;
        --sidebar-text: #e2e8f0;
    }

    .theme-light {
        --bg-color: #f7fafc;
        --text-color: #1a202c;
        --card-bg: #ffffff;
        --card-text: #1a202c;
        --sidebar-bg: #edf2f7;
        --sidebar-text: #1a202c;
    }

    .theme-nature {
        --bg-color: #f0fff4;
        --text-color: #22543d;
        --card-bg: #c6f6d5;
        --card-text: #22543d;
        --sidebar-bg: #9ae6b4;
        --sidebar-text: #22543d;
    }

    .theme-light-blue {
        --bg-color: #e6f2ff;
        --text-color: #1e3a8a;
        --card-bg: #ffffff;
        --card-text: #1e3a8a;
        --sidebar-bg: #bfdbfe;
        --sidebar-text: #1e3a8a;
    }

    .theme-light-orange {
        --bg-color: #fff7ed;
        --text-color: #9a3412;
        --card-bg: #ffedd5;
        --card-text: #9a3412;
        --sidebar-bg: #fed7aa;
        --sidebar-text: #9a3412;
    }

    .theme-yellow {
        --bg-color: #fefce8;
        --text-color: #854d0e;
        --card-bg: #fef9c3;
        --card-text: #854d0e;
        --sidebar-bg: #fde047;
        --sidebar-text: #854d0e;
    }

    .theme-colorful {
        --bg-color: #f0f9ff;
        --text-color: #1e40af;
        --card-bg: linear-gradient(45deg, #fecaca, #bfdbfe, #bbf7d0);
        --card-text: #1e40af;
        --sidebar-bg: linear-gradient(to bottom, #f9a8d4, #93c5fd, #86efac);
        --sidebar-text: #1e40af;
    }

    /* Pomodoro Timer styles */
    #timer-display {
        font-size: 3rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 1rem;
        color: var(--text-color);
    }

    .pomodoro-type.active {
        background-color: var(--text-color);
        color: var(--bg-color);
    }

    input[type="number"] {
        width: 100%;
        padding: 0.5rem;
        border-radius: 0.25rem;
        border: 1px solid var(--text-color);
        background-color: var(--bg-color);
        color: var(--text-color);
    }

    input[type="number"]:focus {
        outline: none;
        border-color: var(--text-color);
        box-shadow: 0 0 0 2px rgba(var(--text-color-rgb), 0.2);
    }

    /* Ripple effect for buttons */
    .ripple {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.7);
        transform: scale(0);
        animation: ripple 0.6s linear;
        pointer-events: none;
    }

    @keyframes ripple {
        to {
            transform: scale(4);
            opacity: 0;
        }
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(65, 105, 225, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(65, 105, 225, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(65, 105, 225, 0);
        }
    }

    .post-card {
        animation: pulse 2s infinite;
    }

    /* Avatar customization styles */
    #avatar-preview {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        margin: 0 auto;
        display: block;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }

    /* Microblog styles */
    #post-content {
        resize: vertical;
        min-height: 100px;
    }

    .mood-emoji {
        font-size: 24px;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .mood-emoji:hover {
        transform: scale(1.2);
    }

    /* Team management styles */
    #teams-list > div {
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 8px;
        background-color: var(--card-bg);
    }

    #teams-list h4 {
        margin-bottom: 0.5rem;
        font-weight: bold;
    }

    /* Lesson modal styles */
    #lesson-modal {
        z-index: 1000;
    }

    #lesson-modal > div {
        max-height: 90vh;
        overflow-y: auto;
    }

    /* Quill editor styles */
    .ql-editor {
        min-height: 200px;
        background-color: var(--card-bg);
        color: var(--text-color);
    }

    /* Responsive design adjustments */
    @media (max-width: 640px) {
        .grid-cols-2 {
            grid-template-columns: 1fr;
        }

        .grid-cols-3 {
            grid-template-columns: 1fr;
        }

        #sidebar {
            width: 100%;
            border-radius: 0;
        }

        #main-content {
            margin: 0;
            border-radius: 0;
        }
    }

    </style>
</head>
<body class="bg-gray-100 font-sans">

<div id="auth-container" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50">
    <div class="neumorphic p-8 w-full max-w-md">
        <h1 id="app-name" class="text-4xl font-bold mb-6 text-center text-primary-color">GamEng!</h1>
        <h2 id="auth-title" class="text-2xl font-bold mb-6 text-center text-indigo-600">Login</h2>
        <div id="login-form">
            <input type="email" id="login-email" placeholder="Email" required class="neumorphic-inset w-full p-3 mb-4" />
            <input type="password" id="login-password" placeholder="Password" required class="neumorphic-inset w-full p-3 mb-4" />
            <button id="login-button" class="neumorphic-button w-full py-3 px-4 text-indigo-600 font-semibold mb-4">Login</button>
            <p class="text-center text-gray-600">Don't have an account? <a href="#" onclick="showRegister()" class="text-indigo-600 font-semibold">Register</a></p>
        </div>

        <div id="register-form" class="hidden">
            <input type="text" id="register-school-code" placeholder="School Code" required class="neumorphic-inset w-full p-3 mb-4" />
            <input type="text" id="register-fullname" placeholder="Full Name" required class="neumorphic-inset w-full p-3 mb-4" />
            <input type="email" id="register-email" placeholder="Email" required class="neumorphic-inset w-full p-3 mb-4" />
            <input type="password" id="register-password" placeholder="Password" required class="neumorphic-inset w-full p-3 mb-4" />
            <select id="register-role" class="neumorphic-inset w-full p-3 mb-4" onchange="toggleGamificationMode()">
                <option value="student">Student</option>
                <option value="teacher">Teacher</option>
            </select>
            <select id="register-gamification-mode" class="neumorphic-inset w-full p-3 mb-4 hidden">
                <option value="">Select Gamification Mode</option>
                <option value="competence">Competence</option>
                <option value="autonomy">Autonomy</option>
                <option value="relatedness">Relatedness</option>
            </select>
            <button onclick="register()" class="neumorphic-button w-full py-3 px-4 text-indigo-600 font-semibold mb-4">Register</button>
            <p class="text-center text-gray-600">Already have an account? <a href="#" onclick="showLogin()" class="text-indigo-600 font-semibold">Login</a></p>
        </div>
    </div>
</div>

<div class="flex h-screen">
    <div id="sidebar" class="neumorphic w-64 p-6 flex flex-col justify-between hidden">
        <div>
            <h2 id="app-title" class="text-2xl font-bold text-center mb-8 text-indigo-600">GamEng!</h2>
            <div id="user-info" class="mb-6">
                <p class="mb-2"><strong class="text-indigo-600">Name:</strong> <span id="user-name" class="text-gray-700"></span></p>
                <p class="mb-2"><strong class="text-indigo-600">Role:</strong> <span id="user-role" class="text-gray-700"></span></p>
                <p><strong class="text-indigo-600">Mode:</strong> <span id="gamification-text" class="text-gray-700"></span></p>
            </div>
            <div id="sidebar-content" class="space-y-4"></div>
        </div>
        <button onclick="logout()" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold hover:text-indigo-700">Logout</button>
    </div>

    <div id="main-content" class="flex-1 p-8 overflow-y-auto hidden">
        <div id="lesson-content">
            <!-- Competence Mode -->
            <div id="competence-mode" class="hidden space-y-8">
                <h3 class="text-2xl font-semibold text-center text-indigo-600 mb-6">Competence Mode</h3>

                <!-- Individual Leaderboard -->
                <div id="individual-leaderboard" class="neumorphic p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-600">Individual Leaderboard</h3>
                    <ul id="individual-leaderboard-list" class="space-y-2"></ul>
                </div>

                <!-- Award Points and Badges to Students (Visible to Teachers Only) -->
                <div id="points-award" class="hidden space-y-6">
                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Award Points to Students</h3>
                        <select id="student-list" class="neumorphic-inset w-full p-2 mb-4"></select>
                        <div class="point-buttons grid grid-cols-2 gap-4">
                            <button onclick="adjustPoints(10)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+10xp</button>
                            <button onclick="adjustPoints(20)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+20xp</button>
                            <button onclick="adjustPoints(50)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+50xp</button>
                            <button onclick="adjustPoints(100)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+100xp</button>
                            <button onclick="adjustPoints(-10)" class="neumorphic-button py-2 px-4 text-red-600 font-semibold">-10xp</button>
                            <button onclick="adjustPoints(-20)" class="neumorphic-button py-2 px-4 text-red-600 font-semibold">-20xp</button>
                            <button onclick="adjustPoints(-50)" class="neumorphic-button py-2 px-4 text-red-600 font-semibold">-50xp</button>
                            <button onclick="adjustPoints(-100)" class="neumorphic-button py-2 px-4 text-red-600 font-semibold">-100xp</button>
                        </div>
                    </div>

                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Award Badges to Students</h3>
                        <div class="badge-buttons grid grid-cols-2 gap-4">
                            <button onclick="awardBadge('first to answer')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">First to Answer</button>
                            <button onclick="awardBadge('first to finish')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">First to Finish</button>
                            <button onclick="awardBadge('Hardworking')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Hardworking</button>
                            <button onclick="awardBadge('Team Player')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Team Player</button>
                            <button onclick="awardBadge('Creative Thinker')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Creative Thinker</button>
                            <button onclick="awardBadge('Problem Solver')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Problem Solver</button>
                            <button onclick="awardBadge('Critical Thinker')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Critical Thinker</button>
                            <button onclick="awardBadge('Persistent')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Persistent</button>
                            <button onclick="awardBadge('Quick Learner')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Quick Learner</button>
                            <button onclick="awardBadge('Leader')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Leader</button>
                        </div>
                    </div>
                </div>

                <!-- Student Progress Bar (Visible to Students Only) -->
                <div id="student-progress" class="hidden space-y-6">
                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Your Progress</h3>
                        <div class="mb-4">
                            <span id="current-level" class="text-indigo-600 font-semibold"></span>
                            <div class="progress-bar h-4 mt-2">
                                <div id="progress" class="progress h-full"></div>
                            </div>
                            <span id="next-level" class="text-indigo-600 font-semibold"></span>
                        </div>
                        <div class="badge-container">
                            <h4 class="text-lg font-semibold mb-2 text-indigo-600">Your Badges</h4>
                            <div id="earned-badges" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Autonomy Mode -->
            <div id="autonomy-mode" class="hidden space-y-8">
                <h3 class="text-2xl font-semibold text-center text-indigo-600 mb-6">Autonomy Mode</h3>
                <div id="avatar-customization" class="neumorphic p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-600">Customize Your Avatar</h3>
                    <img id="avatar-preview" src="https://avataaars.io/?avatarStyle=Circle" alt="Avatar" class="w-32 h-32 rounded-full mx-auto mb-4" />
                    <button onclick="randomizeAvatar()" class="neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold mb-4">Randomize Avatar</button>
                    <button onclick="saveAvatar()" class="neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold">Save Avatar</button>
                </div>
            </div>

            <div id="theme-selection" class="hidden space-y-6">
                <div class="neumorphic p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-600">Theme Selection</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="changeTheme('default')" class="theme-button neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Default</button>
                        <button onclick="changeTheme('dark')" class="theme-button neumorphic-button py-2 px-4 text-gray-200 font-semibold bg-gray-800">Dark</button>
                        <button onclick="changeTheme('light')" class="theme-button neumorphic-button py-2 px-4 text-gray-800 font-semibold bg-gray-100">Light</button>
                        <button onclick="changeTheme('nature')" class="theme-button neumorphic-button py-2 px-4 text-green-800 font-semibold bg-green-200">Nature</button>
                        <button onclick="changeTheme('light-blue')" class="theme-button neumorphic-button py-2 px-4 text-blue-800 font-semibold bg-blue-200">Light Blue</button>
                        <button onclick="changeTheme('light-orange')" class="theme-button neumorphic-button py-2 px-4 text-orange-800 font-semibold bg-orange-200">Light Orange</button>
                        <button onclick="changeTheme('yellow')" class="theme-button neumorphic-button py-2 px-4 text-yellow-800 font-semibold bg-yellow-200">Yellow</button>
                        <button onclick="changeTheme('colorful')" class="theme-button neumorphic-button py-2 px-4 text-purple-800 font-semibold bg-gradient-to-r from-pink-300 via-purple-300 to-indigo-300">Colorful</button>
                    </div>
                </div>
            </div>
            
            <div id="pomodoro-timer" class="hidden space-y-6">
                <div class="neumorphic p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-600">Pomodoro Timer</h3>
                    <div id="timer-display" class="text-4xl font-bold text-center mb-4">25:00</div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <button id="start-timer" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">Start</button>
                        <button id="reset-timer" class="neumorphic-button py-2 px-4 text-red-600 font-semibold">Reset</button>
                    </div>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div>
                            <input type="number" id="pomodoro-time" class="neumorphic-inset w-full p-2 mb-2" value="25" min="1" max="60">
                            <button class="pomodoro-type neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold" data-type="pomodoro">Pomodoro</button>
                        </div>
                        <div>
                            <input type="number" id="short-break-time" class="neumorphic-inset w-full p-2 mb-2" value="5" min="1" max="30">
                            <button class="pomodoro-type neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold" data-type="shortBreak">Short Break</button>
                        </div>
                        <div>
                            <input type="number" id="long-break-time" class="neumorphic-inset w-full p-2 mb-2" value="15" min="1" max="60">
                            <button class="pomodoro-type neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold" data-type="longBreak">Long Break</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Microblog Section -->
            <div id="microblog-section" class="hidden space-y-6">
                <div class="neumorphic p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-600">Microblog</h3>
                    <div id="post-form" class="mb-4">
                        <textarea id="post-content" class="neumorphic-inset w-full p-2 mb-2" rows="3" placeholder="Share your thoughts..."></textarea>
                        <div class="flex justify-between items-center">
                            <div id="mood-selector" class="space-x-2">
                                <button class="mood-emoji" data-mood="happy">üòä</button>
                                <button class="mood-emoji" data-mood="sad">üò¢</button>
                                <button class="mood-emoji" data-mood="excited">üòÉ</button>
                                <button class="mood-emoji" data-mood="tired">üò¥</button>
                                <button class="mood-emoji" data-mood="neutral">üòê</button>
                            </div>
                            <button id="submit-post" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Post</button>
                        </div>
                    </div>
                    <div id="posts-container" class="space-y-4"></div>
                </div>
            </div>

            <!-- Teacher's Microblog View -->
            <div id="teacher-microblog-view" class="hidden space-y-6">
                <div class="neumorphic p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-600">Student Microblogs</h3>
                    <select id="student-microblog-select" class="neumorphic-inset w-full p-2 mb-4"></select>
                    <div id="teacher-posts-container" class="space-y-4"></div>
                </div>
            </div>
            
            <!-- Audio alert for timer -->
            <audio id="timer-audio" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3"></audio>
            
            <!-- Relatedness Mode -->
            <div id="relatedness-mode" class="hidden space-y-8">
                <h3 class="text-2xl font-semibold text-center text-indigo-600 mb-6">Relatedness Mode</h3>

                <!-- Team Leaderboard -->
                <div id="team-leaderboard" class="neumorphic p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-600">Team Leaderboard</h3>
                    <ul id="team-leaderboard-list" class="space-y-2"></ul>
                </div>

                <!-- Team Management (Visible to Teachers Only) -->
                <div id="team-management" class="hidden space-y-6">
                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Team Management</h3>
                        <select id="student-group-list" class="neumorphic-inset w-full p-2 mb-4"></select>
                        <input type="text" id="team-name" placeholder="Enter Team Name" class="neumorphic-inset w-full p-2 mb-4" />
                        <button onclick="assignTeam()" class="neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold">Assign to Team</button>
                    </div>
                    <div id="teams-list" class="neumorphic p-6"></div>

                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Award Points to Teams</h3>
                        <select id="team-select" class="neumorphic-inset w-full p-2 mb-4"></select>
                        <div class="point-buttons grid grid-cols-2 gap-4">
                            <button onclick="awardTeamPoints(10)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+10xp</button>
                            <button onclick="awardTeamPoints(20)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+20xp</button>
                            <button onclick="awardTeamPoints(50)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+50xp</button>
                            <button onclick="awardTeamPoints(100)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+100xp</button>
                        </div>
                    </div>
                </div>

                <!-- Student Team Information (Visible to Students Only) -->
                <div id="student-team-info" class="hidden space-y-6">
                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Your Team: <span id="student-team-name" class="text-indigo-800"></span></h3>
                        <ul id="student-team-members" class="list-disc list-inside space-y-2"></ul>
                    </div>

                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Team Messages</h3>
                        <div id="student-messages-list" class="space-y-4 mb-4"></div>
                        <input type="text" id="team-message-input" placeholder="Enter your message" class="neumorphic-inset w-full p-2 mb-4" />
                        <button onclick="sendMessage()" class="neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lessons Section -->
        <div id="lessons-section" class="hidden space-y-8">
            <h3 class="text-2xl font-semibold text-center text-indigo-600 mb-6">Lessons</h3>
            <div id="lessons-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- Lesson Management Section (Visible to Teachers Only) -->
        <div id="lesson-management" class="hidden space-y-8">
            <h3 class="text-2xl font-semibold text-center text-indigo-600 mb-6">Lesson Management</h3>
            <button onclick="showAddLessonForm()" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Add New Lesson</button>
            <div id="add-lesson-form" class="hidden space-y-4">
                <input type="text" id="lesson-title" placeholder="Lesson Title (required)" class="neumorphic-inset w-full p-2" required>
                <input type="text" id="lesson-task" placeholder="Lesson Task (optional)" class="neumorphic-inset w-full p-2">
                <div id="lesson-editor" class="neumorphic-inset w-full p-2 h-32"></div>
                <input type="file" id="lesson-image" accept="image/*" class="neumorphic-inset w-full p-2">
                <div id="lesson-image-preview-container" class="hidden mt-2">
                    <img id="lesson-image-preview" class="max-w-full h-auto" alt="Image preview" />
                </div>
                <input type="file" id="lesson-pdf" accept=".pdf" class="neumorphic-inset w-full p-2">
                <span id="lesson-pdf-label" class="text-sm text-gray-600"></span>
                <input type="text" id="lesson-link" placeholder="External Link" class="neumorphic-inset w-full p-2">
                <button onclick="saveLesson()" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Save Lesson</button>
            </div>
            <div id="lessons-management-list" class="space-y-4"></div>
        </div>
    </div>
</div>

<!-- Lesson Modal -->
<div id="lesson-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
    <div class="bg-white w-full h-full max-w-5xl mx-auto p-8 rounded-lg shadow-lg relative overflow-auto">
        <button onclick="closeLessonModal()" class="absolute top-4 right-4 text-gray-600 text-2xl font-bold">&times;</button>
        <h2 id="modal-lesson-title" class="text-2xl font-semibold mb-4 text-indigo-600"></h2>
        <div id="modal-lesson-task" class="text-lg mb-4"></div>
        <div id="modal-lesson-content" class="mb-4"></div>
        <div class="flex justify-center mb-4">
            <img id="modal-lesson-image" class="max-w-full h-auto rounded-lg" alt="Lesson Image" />
        </div>
        <a id="modal-lesson-pdf" href="#" target="_blank" class="block mb-2 text-blue-600 hover:underline">Download PDF</a>
        <a id="modal-lesson-link" href="#" target="_blank" class="block text-blue-600 hover:underline">Visit Link</a>
    </div>
</div>

<!-- Include Quill library -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script type="module">
    // Firebase configuration and initialization
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getDatabase, ref, set, get, update, push, remove, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyCYMlv_m2BcTrhm60hLroWVs0W_9SHSVfQ",
    authDomain: "gamification-app-856a4.firebaseapp.com",
    databaseURL: "https://gamification-app-856a4-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "gamification-app-856a4",
    storageBucket: "gamification-app-856a4.appspot.com",
    messagingSenderId: "966888657590",
    appId: "1:966888657590:web:98f5990d1c933f8cbc0c17",
    measurementId: "G-QVK4E2GD51"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const storage = getStorage(app);

// Login function
window.login = async function() {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;

    try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        console.log("Login successful", userCredential.user);
        loadDashboard(userCredential.user);
    } catch (error) {
        console.error("Login failed", error);
        alert("Login failed: " + error.message);
    }
}

// Register function
window.register = async function() {
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const fullName = document.getElementById('register-fullname').value;
    const role = document.getElementById('register-role').value;
    const schoolCode = document.getElementById('register-school-code').value;
    let gamificationMode = document.getElementById('register-gamification-mode').value;

    if (role === 'student') {
        // For students, get the gamification mode from the school
        const schoolRef = ref(db, `schools/${schoolCode}`);
        const schoolSnapshot = await get(schoolRef);
        if (schoolSnapshot.exists()) {
            gamificationMode = schoolSnapshot.val().gamificationMode;
        } else {
            alert('Invalid school code');
            return;
        }
    }

    try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Save additional user info to the database
        await set(ref(db, `users/${user.uid}`), {
            fullName: fullName,
            role: role,
            schoolCode: schoolCode,
            gamificationMode: gamificationMode
        });

        alert('Registration successful! You can now log in.');
        showLogin(); // Switch to login view
    } catch (error) {
        console.error('Registration failed:', error);
        alert('Registration failed: ' + error.message);
    }
}

// Load dashboard
async function loadDashboard(user) {
    try {
        const userRef = ref(db, 'users/' + user.uid);
        const userSnapshot = await get(userRef);
        if (userSnapshot.exists()) {
            const userData = userSnapshot.val();

            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('sidebar').style.display = 'flex';
            document.getElementById('main-content').style.display = 'block';

            document.getElementById('user-name').textContent = userData.fullName;
            document.getElementById('user-role').textContent = userData.role;
            document.getElementById('gamification-text').textContent = userData.gamificationMode;

            // Update sidebar content based on role and gamification mode
            updateSidebarContent(userData.role, userData.gamificationMode);

            // Load specific content based on role and gamification mode
            loadSpecificContent(userData);
        } else {
            alert('No user data available');
        }
    } catch (error) {
        console.error('Failed to load dashboard:', error);
    }
}

// Update sidebar content
function updateSidebarContent(role, mode) {
    const sidebarContent = document.getElementById('sidebar-content');
    sidebarContent.innerHTML = '';

    const commonItems = `
        <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showDashboard()">Dashboard</div>
        <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showLessons()">Lessons</div>
    `;

    let modeSpecificItems = '';
    let teacherActions = '';

    if (mode === 'competence') {
        modeSpecificItems = `
            <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showLeaderboard()">Leaderboard</div>
            <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showProgress()">My Progress</div>
            <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showBadges()">My Badges</div>
        `;
        if (role === 'teacher') {
            teacherActions = `
                <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showStudentProgress()">Student Progress</div>
                <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showBadgeManagement()">Manage Badges</div>
            `;
        }
    } else if (mode === 'autonomy') {
        modeSpecificItems = `
            <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showThemeSelection()">Theme Selection</div>
            <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showAvatarCustomization()">Avatar Customization</div>
            <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showPomodoroTimer()">Pomodoro Timer</div>
            <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showMicroblog()">My Microblog</div>
        `;
        if (role === 'teacher') {
            teacherActions = `
                <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showStudentMicroblogs()">Student Microblogs</div>
            `;
        }
    } else if (mode === 'relatedness') {
        modeSpecificItems = `
            <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showTeamLeaderboard()">Team Leaderboard</div>
        `;
        if (role === 'teacher') {
            teacherActions = `
                <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showTeamManagement()">Manage Teams</div>
            `;
        } else {
            modeSpecificItems += `
                <div class="text-gray-300 hover:text-white cursor-pointer mb-2" onclick="showTeamInfo()">My Team</div>
            `;
        }
    }

    sidebarContent.innerHTML = `
        ${commonItems}
        <div class="mb-4"></div>
        <h3 class="text-white text-lg font-semibold mb-2">${mode.charAt(0).toUpperCase() + mode.slice(1)} Mode</h3>
        ${modeSpecificItems}
    `;

    if (role === 'teacher') {
        sidebarContent.innerHTML += `
            <div class="mt-6">
                <h4 class="text-lg font-semibold mb-2 text-white">Teacher Actions</h4>
                <div class="space-y-2">
                    ${teacherActions}
                </div>
            </div>
        `;
    }

    
}

// Load specific content based on user role and gamification mode
function loadSpecificContent(userData) {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = ''; // Clear existing content

    if (userData.role === 'teacher') {
        loadTeacherDashboard(userData);
    } else {
        loadStudentDashboard(userData);
    }
}

// Load teacher dashboard
function loadTeacherDashboard(userData) {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Welcome, ${userData.fullName}!</h2>
        <p>You are logged in as a teacher in ${userData.gamificationMode} mode.</p>
        <div id="teacher-actions" class="mt-8">
            <h3 class="text-xl font-semibold mb-4">Teacher Actions</h3>
            <button onclick="showLessonManagement()" class="neumorphic-button mb-4">Manage Lessons</button>
            ${userData.gamificationMode === 'competence' ? '<button onclick="showPointsAward()" class="neumorphic-button mb-4">Award Points</button>' : ''}
            ${userData.gamificationMode === 'relatedness' ? '<button onclick="showTeamManagement()" class="neumorphic-button mb-4">Manage Teams</button>' : ''}
            ${userData.gamificationMode === 'autonomy' ? '<button onclick="showStudentMicroblogs()" class="neumorphic-button mb-4">View Student Microblogs</button>' : ''}
        </div>
    `;
}

// Load student dashboard
function loadStudentDashboard(userData) {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Welcome, ${userData.fullName}!</h2>
        <p>You are logged in as a student in ${userData.gamificationMode} mode.</p>
        <div id="student-actions" class="mt-8">
            <h3 class="text-xl font-semibold mb-4">Student Actions</h3>
            <button onclick="showLessons()" class="neumorphic-button mb-4">View Lessons</button>
            ${userData.gamificationMode === 'competence' ? '<button onclick="showProgress()" class="neumorphic-button mb-4">View Progress</button>' : ''}
            ${userData.gamificationMode === 'relatedness' ? '<button onclick="showTeamInfo()" class="neumorphic-button mb-4">View Team Info</button>' : ''}
            ${userData.gamificationMode === 'autonomy' ? '<button onclick="showMicroblog()" class="neumorphic-button mb-4">My Microblog</button>' : ''}
        </div>
    `;
}

// Show login form
window.showLogin = function() {
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('register-form').style.display = 'none';
    document.getElementById('auth-title').textContent = 'Login';
}

// Show register form
window.showRegister = function() {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('register-form').style.display = 'block';
    document.getElementById('auth-title').textContent = 'Register';
}

// Toggle gamification mode selection
window.toggleGamificationMode = function() {
    const roleSelect = document.getElementById('register-role');
    const gamificationModeSelect = document.getElementById('register-gamification-mode');
    
    if (roleSelect.value === 'teacher') {
        gamificationModeSelect.style.display = 'block';
    } else {
        gamificationModeSelect.style.display = 'none';
        gamificationModeSelect.value = ''; // Reset the selection
    }
}

// Logout function
window.logout = function() {
    signOut(auth).then(() => {
        document.getElementById('auth-container').style.display = 'flex';
        document.getElementById('sidebar').style.display = 'none';
        document.getElementById('main-content').style.display = 'none';
    }).catch((error) => {
        console.error('Failed to logout:', error);
    });
}

// Show dashboard
window.showDashboard = function() {
    const user = auth.currentUser;
    if (user) {
        loadDashboard(user);
    }
}

// Show lessons
window.showLessons = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = '<h2 class="text-2xl font-bold mb-4">Lessons</h2><div id="lessons-list"></div>';
    loadLessons();
}

// Load lessons
async function loadLessons() {
    try {
        const lessonsRef = ref(db, 'lessons');
        const snapshot = await get(lessonsRef);
        const lessonsList = document.getElementById('lessons-list');
        lessonsList.innerHTML = ''; // Clear the list first

        snapshot.forEach((childSnapshot) => {
            const lessonData = childSnapshot.val();
            const lessonCard = document.createElement('div');
            lessonCard.className = 'neumorphic p-4 mb-4';
            lessonCard.innerHTML = `
                <h3 class="text-xl font-semibold mb-2">${lessonData.title}</h3>
                <p>${lessonData.task || 'No task specified.'}</p>
                <button onclick="openLessonModal('${childSnapshot.key}')" class="neumorphic-button mt-2">View Lesson</button>
            `;
            lessonsList.appendChild(lessonCard);
        });
    } catch (error) {
        console.error('Failed to load lessons:', error);
    }
}

// Open lesson modal
window.openLessonModal = async function(lessonId) {
    try {
        const lessonRef = ref(db, `lessons/${lessonId}`);
        const snapshot = await get(lessonRef);
        if (snapshot.exists()) {
            const lessonData = snapshot.val();
            document.getElementById('modal-lesson-title').textContent = lessonData.title;
            document.getElementById('modal-lesson-task').textContent = lessonData.task || 'No task specified.';
            document.getElementById('modal-lesson-content').innerHTML = lessonData.content || 'No content available.';
            document.getElementById('modal-lesson-image').src = lessonData.imageUrl || '';
            document.getElementById('modal-lesson-pdf').href = lessonData.pdfUrl || '#';
            document.getElementById('modal-lesson-link').href = lessonData.link || '#';
            document.getElementById('lesson-modal').style.display = 'flex';
        } else {
            alert('Lesson not found');
        }} catch (error) {
        console.error('Failed to load lesson:', error);
    }
}

// Close lesson modal
window.closeLessonModal = function() {
    document.getElementById('lesson-modal').style.display = 'none';
}

// Show lesson management section
window.showLessonManagement = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Lesson Management</h2>
        <button onclick="showAddLessonForm()" class="neumorphic-button mb-4">Add New Lesson</button>
        <div id="add-lesson-form" class="hidden">
            <input type="text" id="lesson-title" placeholder="Lesson Title" class="neumorphic-inset w-full p-2 mb-2">
            <input type="text" id="lesson-task" placeholder="Lesson Task" class="neumorphic-inset w-full p-2 mb-2">
            <div id="lesson-editor" class="neumorphic-inset w-full p-2 mb-2 h-32"></div>
            <input type="file" id="lesson-image" accept="image/*" class="neumorphic-inset w-full p-2 mb-2">
            <input type="file" id="lesson-pdf" accept=".pdf" class="neumorphic-inset w-full p-2 mb-2">
            <input type="text" id="lesson-link" placeholder="External Link" class="neumorphic-inset w-full p-2 mb-2">
            <button onclick="saveLesson()" class="neumorphic-button">Save Lesson</button>
        </div>
        <div id="lessons-management-list"></div>
    `;
    loadLessonsForManagement();
    initQuillEditor();
}

// Initialize Quill editor
function initQuillEditor() {
    const quill = new Quill('#lesson-editor', {
        theme: 'snow'
    });
}

// Show add lesson form
window.showAddLessonForm = function() {
    document.getElementById('add-lesson-form').style.display = 'block';
}

// Save lesson
window.saveLesson = async function() {
    const title = document.getElementById('lesson-title').value;
    const task = document.getElementById('lesson-task').value;
    const content = document.querySelector('.ql-editor').innerHTML;
    const image = document.getElementById('lesson-image').files[0];
    const pdf = document.getElementById('lesson-pdf').files[0];
    const link = document.getElementById('lesson-link').value;

    if (!title) {
        alert('Please enter a lesson title');
        return;
    }

    try {
        const newLessonRef = push(ref(db, 'lessons'));
        const lessonData = {
            title: title,
            task: task,
            content: content,
            link: link
        };

        if (image) {
            const imageRef = storageRef(storage, `lessons/${newLessonRef.key}/image`);
            await uploadBytes(imageRef, image);
            lessonData.imageUrl = await getDownloadURL(imageRef);
        }

        if (pdf) {
            const pdfRef = storageRef(storage, `lessons/${newLessonRef.key}/pdf`);
            await uploadBytes(pdfRef, pdf);
            lessonData.pdfUrl = await getDownloadURL(pdfRef);
        }

        await set(newLessonRef, lessonData);
        alert('Lesson saved successfully!');
        document.getElementById('add-lesson-form').style.display = 'none';
        loadLessonsForManagement();
    } catch (error) {
        console.error('Failed to save lesson:', error);
        alert('Failed to save lesson. Please try again.');
    }
}

// Load lessons for management
async function loadLessonsForManagement() {
    try {
        const lessonsRef = ref(db, 'lessons');
        const snapshot = await get(lessonsRef);
        const lessonsList = document.getElementById('lessons-management-list');
        lessonsList.innerHTML = ''; // Clear the list first

        snapshot.forEach((childSnapshot) => {
            const lessonData = childSnapshot.val();
            const lessonCard = document.createElement('div');
            lessonCard.className = 'neumorphic p-4 mb-4';
            lessonCard.innerHTML = `
                <h3 class="text-xl font-semibold mb-2">${lessonData.title}</h3>
                <p>${lessonData.task || 'No task specified.'}</p>
                <button onclick="editLesson('${childSnapshot.key}')" class="neumorphic-button mt-2 mr-2">Edit</button>
                <button onclick="deleteLesson('${childSnapshot.key}')" class="neumorphic-button mt-2">Delete</button>
            `;
            lessonsList.appendChild(lessonCard);
        });
    } catch (error) {
        console.error('Failed to load lessons for management:', error);
    }
}

// Edit lesson
window.editLesson = async function(lessonId) {
    try {
        const lessonRef = ref(db, `lessons/${lessonId}`);
        const snapshot = await get(lessonRef);
        if (snapshot.exists()) {
            const lessonData = snapshot.val();
            document.getElementById('lesson-title').value = lessonData.title;
            document.getElementById('lesson-task').value = lessonData.task || '';
            document.querySelector('.ql-editor').innerHTML = lessonData.content || '';
            document.getElementById('lesson-link').value = lessonData.link || '';
            document.getElementById('add-lesson-form').style.display = 'block';
            window.currentEditingLessonId = lessonId;
        } else {
            alert('Lesson not found');
        }
    } catch (error) {
        console.error('Failed to load lesson for editing:', error);
    }
}

// Delete lesson
window.deleteLesson = async function(lessonId) {
    if (confirm('Are you sure you want to delete this lesson?')) {
        try {
            await remove(ref(db, `lessons/${lessonId}`));
            alert('Lesson deleted successfully!');
            loadLessonsForManagement();
        } catch (error) {
            console.error('Failed to delete lesson:', error);
            alert('Failed to delete lesson. Please try again.');
        }
    }
}

// Competence Mode Functions

// Show leaderboard
window.showLeaderboard = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = '<h2 class="text-2xl font-bold mb-4">Leaderboard</h2><div id="leaderboard-list"></div>';
    loadLeaderboard();
}

// Load leaderboard
function loadLeaderboard() {
    const user = auth.currentUser;
    const userRef = ref(db, `users/${user.uid}`);
    get(userRef).then((userSnapshot) => {
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;
        const leaderboardRef = ref(db, `schools/${schoolCode}/leaderboard`);
        
        onValue(leaderboardRef, (snapshot) => {
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '';

            const leaderboardData = [];
            snapshot.forEach((childSnapshot) => {
                leaderboardData.push({
                    uid: childSnapshot.key,
                    ...childSnapshot.val()
                });
            });

            leaderboardData.sort((a, b) => b.points - a.points);

            leaderboardData.forEach((entry, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'neumorphic p-4 mb-4';
                listItem.innerHTML = `
                    <span class="font-bold">#${index + 1}</span>
                    <span class="ml-4">${entry.name}</span>
                    <span class="float-right">${entry.points} points</span>
                    <div class="mt-2">
                        ${entry.badges ? entry.badges.map(badge => `<span class="inline-block bg-blue-200 rounded-full px-3 py-1 text-sm font-semibold text-blue-700 mr-2 mb-2">${badge}</span>`).join('') : ''}
                    </div>
                `;
                leaderboardList.appendChild(listItem);
            });
        });
    });
}
// Show points award (for teachers)
window.showPointsAward = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Award Points and Badges</h2>
        <select id="student-list" class="neumorphic-inset w-full p-2 mb-4"></select>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <button onclick="awardPoints(10)" class="neumorphic-button">+10 points</button>
            <button onclick="awardPoints(-10)" class="neumorphic-button">-10 points</button>
            <button onclick="awardPoints(50)" class="neumorphic-button">+50 points</button>
            <button onclick="awardPoints(-50)" class="neumorphic-button">-50 points</button>
        </div>
        <h3 class="text-xl font-bold mb-2">Award Badges</h3>
        <div class="grid grid-cols-2 gap-4">
            <button onclick="awardBadge('First to Answer')" class="neumorphic-button">First to Answer</button>
            <button onclick="awardBadge('Problem Solver')" class="neumorphic-button">Problem Solver</button>
            <button onclick="awardBadge('Team Player')" class="neumorphic-button">Team Player</button>
            <button onclick="awardBadge('Critical Thinker')" class="neumorphic-button">Critical Thinker</button>
        </div>
    `;
    loadStudentList();
}

// Load student list
async function loadStudentList() {
    try {
        const user = auth.currentUser;
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const usersRef = ref(db, 'users');
        const snapshot = await get(usersRef);
        const studentList = document.getElementById('student-list');
        studentList.innerHTML = '<option value="">Select a student</option>';

        snapshot.forEach((childSnapshot) => {
            const studentData = childSnapshot.val();
            if (studentData.role === 'student' && studentData.schoolCode === schoolCode) {
                const option = document.createElement('option');
                option.value = childSnapshot.key;
                option.textContent = studentData.fullName;
                studentList.appendChild(option);
            }
        });
    } catch (error) {
        console.error('Failed to load student list:', error);
    }
}

// Award points
window.awardPoints = async function(points) {
    const studentId = document.getElementById('student-list').value;
    if (!studentId) {
        alert('Please select a student');
        return;
    }

    try {
        const studentRef = ref(db, `users/${studentId}`);
        const studentSnapshot = await get(studentRef);
        const studentData = studentSnapshot.val();
        const newPoints = (studentData.points || 0) + points;

        await update(studentRef, { points: newPoints });

        const leaderboardRef = ref(db, `schools/${studentData.schoolCode}/leaderboard/${studentId}`);
        await set(leaderboardRef, {
            name: studentData.fullName,
            points: newPoints
        });

        alert(`Points updated for ${studentData.fullName}`);
    } catch (error) {
        console.error('Failed to award points:', error);
        alert('Failed to award points. Please try again.');
    }
}

// Award badges to students (for teachers)
window.awardBadge = async function(badgeName) {
    const studentId = document.getElementById('student-list').value;
    if (!studentId) {
        alert('Please select a student');
        return;
    }

    try {
        const studentRef = ref(db, `users/${studentId}`);
        const studentSnapshot = await get(studentRef);
        const studentData = studentSnapshot.val();

        let badges = studentData.badges || [];
        if (!badges.includes(badgeName)) {
            badges.push(badgeName);
            await update(studentRef, { badges: badges });

            // Update leaderboard with new badge
            const leaderboardRef = ref(db, `schools/${studentData.schoolCode}/leaderboard/${studentId}`);
            await update(leaderboardRef, { badges: badges });

            alert(`Badge "${badgeName}" awarded to ${studentData.fullName}`);
        } else {
            alert(`${studentData.fullName} already has the "${badgeName}" badge.`);
        }
    } catch (error) {
        console.error('Failed to award badge:', error);
        alert('Failed to award badge. Please try again.');
    }
}

// Show student progress
window.showProgress = function() {
    const user = auth.currentUser;
    const userRef = ref(db, `users/${user.uid}`);
    
    onValue(userRef, (snapshot) => {
        const userData = snapshot.val();
        const mainContent = document.getElementById('main-content');
        
        const level = Math.floor(userData.points / 100) + 1;
        const progress = (userData.points % 100);

        mainContent.innerHTML = `
            <h2 class="text-2xl font-bold mb-4">My Progress</h2>
            <div class="neumorphic p-4 mb-4">
                <p>Total Points: ${userData.points || 0}</p>
                <p>Level: ${level}</p>
                <div class="progress-bar mt-2">
                    <div class="progress" style="width: ${progress}%;"></div>
                </div>
                <p class="mt-2">Progress to next level: ${progress}%</p>
            </div>
            <h3 class="text-xl font-bold mb-2">Badges</h3>
            <div id="badges-list" class="grid grid-cols-3 gap-4"></div>
        `;

        const badgesList = document.getElementById('badges-list');
        if (userData.badges && userData.badges.length > 0) {
            userData.badges.forEach(badge => {
                const badgeElement = document.createElement('div');
                badgeElement.className = 'neumorphic p-2 text-center';
                badgeElement.textContent = badge;
                badgesList.appendChild(badgeElement);
            });
        } else {
            badgesList.innerHTML = '<p>No badges earned yet.</p>';
        }
    });
}
// Autonomy Mode Functions

// Show theme selection
window.showThemeSelection = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Theme Selection</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <button onclick="changeTheme('default')" class="neumorphic-button p-4">Default</button>
            <button onclick="changeTheme('dark')" class="neumorphic-button p-4">Dark</button>
            <button onclick="changeTheme('light')" class="neumorphic-button p-4">Light</button>
            <button onclick="changeTheme('nature')" class="neumorphic-button p-4">Nature</button>
        </div>
    `;
}

// Change theme
window.changeTheme = async function(theme) {
    document.body.className = `theme-${theme}`;
    const user = auth.currentUser;
    try {
        await update(ref(db, `users/${user.uid}`), { theme: theme });
        alert('Theme updated successfully!');
    } catch (error) {
        console.error('Failed to update theme:', error);
    }
}

// Show Pomodoro timer
window.showPomodoroTimer = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Pomodoro Timer</h2>
        <div class="neumorphic p-4 mb-4">
            <div id="timer" class="text-4xl font-bold text-center mb-4">25:00</div>
            <div class="grid grid-cols-2 gap-4">
                <button id="start-timer" class="neumorphic-button p-2">Start</button>
                <button id="reset-timer" class="neumorphic-button p-2">Reset</button>
            </div>
        </div>
    `;
    initPomodoroTimer();
}

// Initialize Pomodoro timer
function initPomodoroTimer() {
    let timer;
    let timeLeft = 25 * 60;
    const timerDisplay = document.getElementById('timer');
    const startButton = document.getElementById('start-timer');
    const resetButton = document.getElementById('reset-timer');

    function updateTimerDisplay() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    startButton.addEventListener('click', function() {
        if (timer) {
            clearInterval(timer);
            startButton.textContent = 'Start';
            timer = null;
        } else {
            startButton.textContent = 'Pause';
            timer = setInterval(function() {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft === 0) {
                    clearInterval(timer);
                    alert('Pomodoro session completed!');
                    timeLeft = 25 * 60;
                    updateTimerDisplay();
                    startButton.textContent = 'Start';
                }
            }, 1000);
        }
    });

    resetButton.addEventListener('click', function() {
        clearInterval(timer);
        timeLeft = 25 * 60;
        updateTimerDisplay();
        startButton.textContent = 'Start';
    });

    updateTimerDisplay();
}

// Show microblog
window.showMicroblog = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">My Microblog</h2>
        <div class="neumorphic p-4 mb-4">
            <textarea id="post-content" class="w-full p-2 mb-2 neumorphic-inset" rows="3" placeholder="What's on your mind?"></textarea>
            <div class="flex justify-between items-center">
                <div id="mood-selector" class="space-x-2">
                    <button class="mood-emoji" data-mood="happy">üòä</button>
                    <button class="mood-emoji" data-mood="sad">üò¢</button>
                    <button class="mood-emoji" data-mood="excited">üòÉ</button>
                    <button class="mood-emoji" data-mood="tired">üò¥</button>
                    <button class="mood-emoji" data-mood="neutral">üòê</button>
                </div>
                <button onclick="createPost()" class="neumorphic-button p-2">Post</button>
            </div>
        </div>
        <div id="posts-list"></div>
    `;
    loadPosts();
    initMoodSelector();
}

// Initialize mood selector
function initMoodSelector() {
    const moodButtons = document.querySelectorAll('.mood-emoji');
    moodButtons.forEach(button => {
        button.addEventListener('click', function() {
            moodButtons.forEach(btn => btn.classList.remove('selected'));
            this.classList.add('selected');
        });
    });
}

// Create a new post
window.createPost = async function() {
    const content = document.getElementById('post-content').value;
    const selectedMood = document.querySelector('.mood-emoji.selected');
    const mood = selectedMood ? selectedMood.getAttribute('data-mood') : null;

    if (!content.trim()) {
        alert('Please enter some content for your post.');
        return;
    }

    const user = auth.currentUser;
    try {
        const postRef = push(ref(db, `posts/${user.uid}`));
        await set(postRef, {
            content: content,
            mood: mood,
            timestamp: serverTimestamp()
        });
        document.getElementById('post-content').value = '';
        document.querySelectorAll('.mood-emoji').forEach(btn => btn.classList.remove('selected'));
        loadPosts();
    } catch (error) {
        console.error('Failed to create post:', error);
    }
}

// Load posts
async function loadPosts() {
    const user = auth.currentUser;
    const postsRef = ref(db, `posts/${user.uid}`);
    const postsList = document.getElementById('posts-list');
    postsList.innerHTML = '';

    onValue(postsRef, (snapshot) => {
        postsList.innerHTML = '';
        const posts = [];
        snapshot.forEach((childSnapshot) => {
            posts.push({
                id: childSnapshot.key,
                ...childSnapshot.val()
            });
        });

        // Sort posts by timestamp in descending order
        posts.sort((a, b) => b.timestamp - a.timestamp);

        posts.forEach((post) => {
            const postElement = createPostElement(post);
            postsList.appendChild(postElement);
        });
    });
}

// Create a post element
function createPostElement(post) {
    const postElement = document.createElement('div');
    postElement.className = 'neumorphic p-4 mb-4';
    
    const moodEmoji = post.mood ? `<span class="text-2xl mr-2">${getMoodEmoji(post.mood)}</span>` : '';
    const formattedDate = new Date(post.timestamp).toLocaleString();

    postElement.innerHTML = `
        <div class="flex justify-between items-start mb-2">
            ${moodEmoji}
            <span class="text-sm text-gray-500">${formattedDate}</span>
        </div>
        <p class="text-gray-800">${post.content}</p>
    `;

    return postElement;
}

// Get mood emoji
function getMoodEmoji(mood) {
    const emojis = {
        happy: 'üòä',
        sad: 'üò¢',
        excited: 'üòÉ',
        tired: 'üò¥',
        neutral: 'üòê'
    };
    return emojis[mood] || '';
}

// Show student microblogs (for teachers)
window.showStudentMicroblogs = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Student Microblogs</h2>
        <select id="student-microblog-select" class="neumorphic-inset w-full p-2 mb-4"></select>
        <div id="student-posts-list"></div>
    `;
    loadStudentsForMicroblog();
}

// Load students for microblog selection
async function loadStudentsForMicroblog() {
    try {
        const user = auth.currentUser;
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const usersRef = ref(db, 'users');
        const snapshot = await get(usersRef);
        const studentSelect = document.getElementById('student-microblog-select');
        studentSelect.innerHTML = '<option value="">Select a student</option>';

        snapshot.forEach((childSnapshot) => {
            const studentData = childSnapshot.val();
            if (studentData.role === 'student' && studentData.schoolCode === schoolCode) {
                const option = document.createElement('option');
                option.value = childSnapshot.key;
                option.textContent = studentData.fullName;
                studentSelect.appendChild(option);
            }
        });

        studentSelect.addEventListener('change', function() {
            if (this.value) {
                loadStudentPosts(this.value);
            }
        });
    } catch (error) {
        console.error('Failed to load students for microblog:', error);
    }
}

// Load student posts
function loadStudentPosts(studentId) {
    const postsRef = ref(db, `posts/${studentId}`);
    const postsList = document.getElementById('student-posts-list');
    postsList.innerHTML = '';

    onValue(postsRef, (snapshot) => {
        postsList.innerHTML = '';
        const posts = [];
        snapshot.forEach((childSnapshot) => {
            posts.push({
                id: childSnapshot.key,
                ...childSnapshot.val()
            });
        });

        // Sort posts by timestamp in descending order
        posts.sort((a, b) => b.timestamp - a.timestamp);

        posts.forEach((post) => {
            const postElement = createPostElement(post);
            postsList.appendChild(postElement);
        });
    });
}

// Relatedness Mode Functions

// Show team leaderboard
window.showTeamLeaderboard = async function() {
    const user = auth.currentUser;
    const userRef = ref(db, `users/${user.uid}`);
    const userSnapshot = await get(userRef);
    const userData = userSnapshot.val();
    const schoolCode = userData.schoolCode;

    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Team Leaderboard</h2>
        <ul id="team-leaderboard-list" class="space-y-2"></ul>
    `;

    setupTeamPointsListener(schoolCode);
}

// Load team leaderboard
async function loadTeamLeaderboard() {
    try {
        const user = auth.currentUser;
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const teamsRef = ref(db, `schools/${schoolCode}/teams`);
        const snapshot = await get(teamsRef);
        const leaderboardList = document.getElementById('team-leaderboard-list');
        leaderboardList.innerHTML = ''; // Clear the list first

        const leaderboardData = [];
        snapshot.forEach((childSnapshot) => {
            const teamData = childSnapshot.val();
            leaderboardData.push({
                name: childSnapshot.key,
                points: teamData.points || 0
            });
        });

        // Sort leaderboard by points in descending order
        leaderboardData.sort((a, b) => b.points - a.points);

        leaderboardData.forEach((entry, index) => {
            const listItem = document.createElement('div');
            listItem.className = 'neumorphic p-4 mb-4';
            listItem.innerHTML = `
                <span class="font-bold">#${index + 1}</span>
                <span class="ml-4">${entry.name}</span>
                <span class="float-right">${entry.points} points</span>
            `;
            leaderboardList.appendChild(listItem);
        });
    } catch (error) {
        console.error('Failed to load team leaderboard:', error);
    }
}

// Show team management (for teachers)
window.showTeamManagement = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Team Management</h2>
        <div class="neumorphic p-4 mb-4">
            <h3 class="text-xl font-bold mb-2">Create Team</h3>
            <input type="text" id="team-name" placeholder="Team Name" class="w-full p-2 mb-2 neumorphic-inset">
            <button onclick="createTeam()" class="neumorphic-button p-2">Create Team</button>
        </div>
        <div class="neumorphic p-4 mb-4">
            <h3 class="text-xl font-bold mb-2">Assign Student to Team</h3>
            <select id="student-select" class="w-full p-2 mb-2 neumorphic-inset"></select>
            <select id="team-select" class="w-full p-2 mb-2 neumorphic-inset"></select>
            <button onclick="assignStudentToTeam()" class="neumorphic-button p-2">Assign Student</button>
        </div>
        <div class="neumorphic p-4 mb-4">
            <h3 class="text-xl font-bold mb-2">Award Points to Team</h3>
            <select id="team-points-select" class="w-full p-2 mb-2 neumorphic-inset"></select>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="awardTeamPoints(10)" class="neumorphic-button p-2">+10 Points</button>
                <button onclick="awardTeamPoints(20)" class="neumorphic-button p-2">+20 Points</button>
                <button onclick="awardTeamPoints(50)" class="neumorphic-button p-2">+50 Points</button>
                <button onclick="awardTeamPoints(100)" class="neumorphic-button p-2">+100 Points</button>
            </div>
        </div>
        <div id="teams-list"></div>
    `;
    loadTeamsAndStudents();
    loadTeamsForPointsAwarding();
}

async function loadTeamsForPointsAwarding() {
    const teamPointsSelect = document.getElementById('team-points-select');
    teamPointsSelect.innerHTML = '<option value="">Select a team</option>';
    
    try {
        const user = auth.currentUser;
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const teamsRef = ref(db, `schools/${schoolCode}/teams`);
        const teamsSnapshot = await get(teamsRef);
        
        if (teamsSnapshot.exists()) {
            teamsSnapshot.forEach((childSnapshot) => {
                const teamName = childSnapshot.key;
                const option = document.createElement('option');
                option.value = teamName;
                option.textContent = teamName;
                teamPointsSelect.appendChild(option);
            });
        } else {
            console.log('No teams found');
        }
    } catch (error) {
        console.error('Error loading teams for points awarding:', error);
    }
}


// Create a new team
window.createTeam = async function() {
    const teamName = document.getElementById('team-name').value;
    if (!teamName.trim()) {
        alert('Please enter a team name.');
        return;
    }

    const user = auth.currentUser;
    try {
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const teamRef = ref(db, `schools/${schoolCode}/teams/${teamName}`);
        await set(teamRef, { points: 0, members: [] });
        alert('Team created successfully!');
        loadTeamsAndStudents();
    } catch (error) {
        console.error('Failed to create team:', error);
    }
}

// Assign student to team
window.assignStudentToTeam = async function() {
    const studentId = document.getElementById('student-select').value;
    const teamName = document.getElementById('team-select').value;
    if (!studentId || !teamName) {
        alert('Please select both a student and a team.');
        return;
    }

    const user = auth.currentUser;
    try {
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const teamRef = ref(db, `schools/${schoolCode}/teams/${teamName}/members`);
        const teamSnapshot = await get(teamRef);
        const teamMembers = teamSnapshot.val() || [];
        if (!teamMembers.includes(studentId)) {
            teamMembers.push(studentId);
            await set(teamRef, teamMembers);
            await update(ref(db, `users/${studentId}`), { team: teamName });
            alert('Student assigned to team successfully!');
            loadTeamsAndStudents();
        } else {
            alert('Student is already in this team.');
        }
    } catch (error) {
        console.error('Failed to assign student to team:', error);
    }
}

// Load teams and students
async function loadTeamsAndStudents() {
    const user = auth.currentUser;
    try {
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const teamsRef = ref(db, `schools/${schoolCode}/teams`);
        const teamsSnapshot = await get(teamsRef);
        const teamSelect = document.getElementById('team-select');
        teamSelect.innerHTML = '<option value="">Select a team</option>';
        teamsSnapshot.forEach((childSnapshot) => {
            const option = document.createElement('option');
            option.value = childSnapshot.key;
            option.textContent = childSnapshot.key;
            teamSelect.appendChild(option);
        });

        const usersRef = ref(db, 'users');
        const usersSnapshot = await get(usersRef);
        const studentSelect = document.getElementById('student-select');
        studentSelect.innerHTML = '<option value="">Select a student</option>';
        usersSnapshot.forEach((childSnapshot) => {
            const studentData = childSnapshot.val();
            if (studentData.role === 'student' && studentData.schoolCode === schoolCode) {
                const option = document.createElement('option');
                option.value = childSnapshot.key;
                option.textContent = studentData.fullName;
                studentSelect.appendChild(option);
            }
        });

        const teamsList = document.getElementById('teams-list');
        teamsList.innerHTML = '';
        teamsSnapshot.forEach((childSnapshot) => {
            const teamData = childSnapshot.val();
            const teamElement = document.createElement('div');
            teamElement.className = 'neumorphic p-4 mb-4';
            teamElement.innerHTML = `
                <h3 class="text-xl font-bold mb-2">${childSnapshot.key}</h3>
                <p>Points: ${teamData.points || 0}</p>
                <h4 class="font-bold mt-2">Members:</h4>
                <ul id="team-${childSnapshot.key}-members" class="list-disc list-inside"></ul>
            `;
            teamsList.appendChild(teamElement);

            const membersListElement = teamElement.querySelector(`#team-${childSnapshot.key}-members`);
            if (teamData.members && teamData.members.length > 0) {
                teamData.members.forEach(async (memberId) => {
                    const memberRef = ref(db, `users/${memberId}`);
                    const memberSnapshot = await get(memberRef);
                    const memberData = memberSnapshot.val();
                    const memberListItem = document.createElement('li');
                    memberListItem.textContent = memberData.fullName;
                    membersListElement.appendChild(memberListItem);
                });
            } else {
                membersListElement.innerHTML = '<li>No members yet</li>';
            }
        });
    } catch (error) {
        console.error('Failed to load teams and students:', error);
    }
}

// Show team info (for students)
window.showTeamInfo = async function() {
    const user = auth.currentUser;
    try {
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        
        if (!userData.team) {
            alert('You are not assigned to a team yet.');
            return;
        }

        const schoolCode = userData.schoolCode;
        const teamRef = ref(db, `schools/${schoolCode}/teams/${userData.team}`);
        const teamSnapshot = await get(teamRef);
        const teamData = teamSnapshot.val();

        const mainContent = document.getElementById('main-content');
        mainContent.innerHTML = `
            <h2 class="text-2xl font-bold mb-4">My Team: ${userData.team}</h2>
            <div class="neumorphic p-4 mb-4">
                <p>Team Points: ${teamData.points || 0}</p>
                <h3 class="text-xl font-bold mt-4 mb-2">Team Members:</h3>
                <ul id="team-members-list" class="list-disc list-inside"></ul>
            </div>
            <div class="neumorphic p-4 mb-4">
                <h3 class="text-xl font-bold mb-2">Team Chat</h3>
                <div id="team-chat" class="h-64 overflow-y-auto mb-4 p-2 neumorphic-inset"></div>
                <input type="text" id="chat-message" placeholder="Type your message" class="w-full p-2 mb-2 neumorphic-inset">
                <button onclick="sendTeamMessage()" class="neumorphic-button p-2">Send Message</button>
            </div>
        `;

        const teamMembersList = document.getElementById('team-members-list');
        if (teamData.members && teamData.members.length > 0) {
            teamData.members.forEach(async (memberId) => {
                const memberRef = ref(db, `users/${memberId}`);
                const memberSnapshot = await get(memberRef);
                const memberData = memberSnapshot.val();
                const memberListItem = document.createElement('li');
                memberListItem.textContent = memberData.fullName;
                teamMembersList.appendChild(memberListItem);
            });
        } else {
            teamMembersList.innerHTML = '<li>No other members yet</li>';
        }

        loadTeamChat(schoolCode, userData.team);
    } catch (error) {
        console.error('Failed to load team info:', error);
    }
}

// Load team chat
function loadTeamChat(schoolCode, teamName) {
    const chatRef = ref(db, `schools/${schoolCode}/teams/${teamName}/chat`);
    const chatElement = document.getElementById('team-chat');

    onValue(chatRef, (snapshot) => {
        chatElement.innerHTML = '';
        snapshot.forEach((childSnapshot) => {
            const message = childSnapshot.val();
            const messageElement = document.createElement('div');
            messageElement.className = 'mb-2';
            messageElement.innerHTML = `
                <strong>${message.sender}:</strong> ${message.text}
                <small class="text-gray-500 ml-2">${new Date(message.timestamp).toLocaleString()}</small>
            `;
            chatElement.appendChild(messageElement);
        });
        chatElement.scrollTop = chatElement.scrollHeight;
    });
}

// Send team message
window.sendTeamMessage = async function() {
    const user = auth.currentUser;
    const messageText = document.getElementById('chat-message').value;
    if (!messageText.trim()) {
        alert('Please enter a message.');
        return;
    }

    try {
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;
        const teamName = userData.team;

        const chatRef = ref(db, `schools/${schoolCode}/teams/${teamName}/chat`);
        const newMessageRef = push(chatRef);
        await set(newMessageRef, {
            sender: userData.fullName,
            text: messageText,
            timestamp: serverTimestamp()
        });

        document.getElementById('chat-message').value = '';
    } catch (error) {
        console.error('Failed to send team message:', error);
    }
}

// Utility Functions

// Load user data
async function loadUserData(uid) {
    const userRef = ref(db, `users/${uid}`);
    const snapshot = await get(userRef);
    return snapshot.val();
}

// Apply theme
function applyTheme(theme) {
    document.body.className = `theme-${theme}`;
}

// Authentication state change handler
auth.onAuthStateChanged(async (user) => {
    if (user) {
        const userData = await loadUserData(user.uid);
        if (userData.theme) {
            applyTheme(userData.theme);
        }
        loadDashboard(user);
    } else {
        document.getElementById('auth-container').style.display = 'flex';
        document.getElementById('sidebar').style.display = 'none';
        document.getElementById('main-content').style.display = 'none';
    }
});

// Initialize application
function initApp() {
    document.getElementById('login-button').addEventListener('click', login);
    document.getElementById('register-role').addEventListener('change', toggleGamificationMode);
    
    // Ensure the gamification mode is hidden initially
    toggleGamificationMode();
}

// Call initApp when the DOM is fully loaded
document.addEventListener('DOMContentLoaded', initApp);

// Add ripple effect to buttons
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('neumorphic-button')) {
        const button = e.target;
        const ripple = document.createElement('span');
        const rect = button.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        
        ripple.style.width = ripple.style.height = `${size}px`;
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;
        ripple.classList.add('ripple');
        
        button.appendChild(ripple);
        
        setTimeout(() => {
            ripple.remove();
        }, 600);
    }
});

window.showAvatarCustomization = function() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Avatar Customization</h2>
        <div id="avatar-customization" class="neumorphic p-6">
            <h3 class="text-xl font-semibold mb-4 text-indigo-600">Customize Your Avatar</h3>
            <img id="avatar-preview" src="https://avataaars.io/?avatarStyle=Circle" alt="Avatar" class="w-32 h-32 rounded-full mx-auto mb-4" />
            <button onclick="randomizeAvatar()" class="neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold mb-4">Randomize Avatar</button>
            <button onclick="saveAvatar()" class="neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold">Save Avatar</button>
        </div>
    `;
    loadAvatar();
}
window.randomizeAvatar = function() {
    const avatarParams = {
        topType: getRandomTopType(),
        accessoriesType: getRandomAccessoriesType(),
        hairColor: getRandomHairColor(),
        facialHairType: getRandomFacialHairType(),
        facialHairColor: getRandomFacialHairColor(),
        clotheType: getRandomClotheType(),
        clotheColor: getRandomClotheColor(),
        eyeType: getRandomEyeType(),
        eyebrowType: getRandomEyebrowType(),
        mouthType: getRandomMouthType(),
        skinColor: getRandomSkinColor(),
    };

    const avatarUrl = `https://avataaars.io/?${new URLSearchParams(avatarParams)}`;
    document.getElementById('avatar-preview').src = avatarUrl;
}

window.saveAvatar = async function() {
    const avatarUrl = document.getElementById('avatar-preview').src;
    const user = auth.currentUser;

    if (user) {
        try {
            await update(ref(db, 'users/' + user.uid), { avatarUrl: avatarUrl });
            alert('Avatar saved successfully!');
        } catch (error) {
            alert('Failed to save avatar: ' + error.message);
        }
    }
}

window.getRandomTopType = function() {
    const topTypes = [
        'NoHair', 'Eyepatch', 'Hat', 'Hijab', 'Turban', 'WinterHat1', 'LongHairStraight',
        'LongHairCurvy', 'ShortHairShortCurly', 'ShortHairShaggyMullet'
    ];
    return topTypes[Math.floor(Math.random() * topTypes.length)];
}

window.getRandomAccessoriesType = function() {
    const accessoriesTypes = ['Blank', 'Kurt', 'Prescription02', 'Round'];
    return accessoriesTypes[Math.floor(Math.random() * accessoriesTypes.length)];
}

window.getRandomHairColor = function() {
    const hairColors = ['Auburn', 'Black', 'Blonde', 'BrownDark', 'Red', 'SilverGray'];
    return hairColors[Math.floor(Math.random() * hairColors.length)];
}

window.getRandomFacialHairType = function() {
    const facialHairTypes = ['Blank', 'BeardLight', 'MoustacheFancy'];
    return facialHairTypes[Math.floor(Math.random() * facialHairTypes.length)];
}

window.getRandomFacialHairColor = function() {
    const facialHairColors = ['Black', 'BrownDark', 'Red'];
    return facialHairColors[Math.floor(Math.random() * facialHairColors.length)];
}

window.getRandomClotheType = function() {
    const clotheTypes = ['BlazerShirt', 'BlazerSweater', 'Hoodie', 'Overall'];
    return clotheTypes[Math.floor(Math.random() * clotheTypes.length)];
}

window.getRandomClotheColor = function() {
    const clotheColors = ['PastelBlue', 'PastelGreen', 'PastelOrange', 'PastelRed'];
    return clotheColors[Math.floor(Math.random() * clotheColors.length)];
}

window.getRandomEyeType = function() {
    const eyeTypes = ['Close', 'Cry', 'Happy', 'Hearts'];
    return eyeTypes[Math.floor(Math.random() * eyeTypes.length)];
}

window.getRandomEyebrowType = function() {
    const eyebrowTypes = ['Angry', 'Default', 'FlatNatural', 'RaisedExcited'];
    return eyebrowTypes[Math.floor(Math.random() * eyebrowTypes.length)];
}

window.getRandomMouthType = function() {
    const mouthTypes = ['Smile', 'Disbelief', 'Serious', 'ScreamOpen'];
    return mouthTypes[Math.floor(Math.random() * mouthTypes.length)];
}

window.getRandomSkinColor = function() {
    const skinColors = ['Light', 'Brown', 'Black', 'Pale'];
    return skinColors[Math.floor(Math.random() * skinColors.length)];
}

window.loadAvatar = async function() {
    const user = auth.currentUser;
    if (user) {
        const userSnapshot = await get(ref(db, 'users/' + user.uid));
        if (userSnapshot.exists()) {
            const userData = userSnapshot.val();
            const avatarUrl = userData.avatarUrl || 'https://avataaars.io/?avatarStyle=Circle';
            document.getElementById('avatar-preview').src = avatarUrl;
        }
    }
}
window.awardTeamPoints = async function(points) {
    const teamSelect = document.getElementById('team-points-select');
    const selectedTeamName = teamSelect.value;

    if (!selectedTeamName) {
        alert('Please select a team first.');
        return;
    }

    try {
        const user = auth.currentUser;
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();
        const schoolCode = userData.schoolCode;

        const teamRef = ref(db, `schools/${schoolCode}/teams/${selectedTeamName}`);
        const teamSnapshot = await get(teamRef);

        if (teamSnapshot.exists()) {
            const teamData = teamSnapshot.val();
            const newPoints = (teamData.points || 0) + points;

            await update(teamRef, { points: newPoints });
            alert(`Successfully awarded ${points} points to ${selectedTeamName}!`);
            // The listener will automatically update the leaderboard
        } else {
            alert('Selected team not found.');
        }
    } catch (error) {
        console.error('Error awarding team points:', error);
        alert('Failed to award points. Please try again.');
    }
}

async function populateTeamSelect() {
    const teamSelect = document.getElementById('team-select');
    teamSelect.innerHTML = '<option value="">Select a team</option>';

    try {
        const teamsSnapshot = await get(ref(db, 'teams'));
        if (teamsSnapshot.exists()) {
            const teamsData = teamsSnapshot.val();
            for (const teamId in teamsData) {
                const team = teamsData[teamId];
                const option = document.createElement('option');
                option.value = teamId;
                option.textContent = team.name;
                teamSelect.appendChild(option);
            }
        }
    } catch (error) {
        console.error('Error populating team select:', error);
    }
}

function updateTeamLeaderboard(teamsData) {
    const leaderboardList = document.getElementById('team-leaderboard-list');
    if (!leaderboardList) return; // Exit if the leaderboard element doesn't exist

    leaderboardList.innerHTML = '';
    
    const sortedTeams = Object.entries(teamsData)
        .sort(([, a], [, b]) => (b.points || 0) - (a.points || 0));

    sortedTeams.forEach(([teamName, teamData], index) => {
        const listItem = document.createElement('li');
        listItem.className = 'mb-2 p-2 bg-white rounded shadow';
        listItem.innerHTML = `
            <span class="font-bold">${index + 1}.</span>
            <span class="ml-2">${teamName}:</span>
            <span class="ml-2 font-semibold">${teamData.points || 0} points</span>
        `;
        leaderboardList.appendChild(listItem);
    });
}

function initRelatednessMode() {
    showTeamLeaderboard();
    if (currentUserRole === 'teacher') {
        showTeamManagement();
    } else {
        showTeamInfo();
    }
}

function setupTeamPointsListener(schoolCode) {
    const teamsRef = ref(db, `schools/${schoolCode}/teams`);
    onValue(teamsRef, (snapshot) => {
        if (snapshot.exists()) {
            updateTeamLeaderboard(snapshot.val());
        }
    });
}

</script>
</body>
</html>
